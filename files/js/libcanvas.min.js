(function(e,t){var n,r=this,i=[].slice,s=e.declare,o=e.Registry,u=e.Events,a=e.Settings;var f=this.LibCanvas=s({name:"LibCanvas",prototype:{}}).own({Buffer:function(){return f.buffer.apply(f,arguments)},buffer:function(t,n,r){var s,o,u=i.call(arguments),a=u[u.length-1];r=typeof a==="boolean"?u.pop():false;o=m(u.length==1?u[0]:u);s=e.dom.create("canvas",{width:o.width,height:o.height}).first;if(r)s.ctx=new S(s);return s},"declare.classes":{},declare:function(e,t,n,r){if(typeof t=="object"){r=n;n=t;t=null}if(r==null){r=n;n=null}var i=s(e,n,r);if(t){if(t in this["declare.classes"]){throw new Error("Duplicate declaration: "+t)}this["declare.classes"][t]=i}return i},extract:function(e){e=e||r;for(var t in this["declare.classes"]){e[t]=this["declare.classes"][t]}return e}});f.declare("LibCanvas.App","App",{initialize:function(t){this.bindMethods("tick");this.layers=[];this.settings=(new a({appendTo:"body"})).set(t);this.container=new l.Container(this.settings.subset(["simple","size","appendTo"]));this.resources=new o;e.frame.add(this.tick)},destroy:function(){e.array.invoke(this.layers,"destroy");e.frame.remove(this.tick);this.container.destroy()},get rectangle(){return this.container.rectangle},zIndexCompare:function(e,t,n){var r,i,s=n?-1:+1;if(!e||!e.layer)throw new TypeError("Wrong left element");if(!t||!t.layer)throw new TypeError("Wrong right element");r=e.layer.dom.zIndex;i=t.layer.dom.zIndex;if(r>i)return-1*s;if(r<i)return+1*s;r=e.zIndex;i=t.zIndex;if(r>i)return-1*s;if(r<i)return+1*s;return 0},createLayer:function(e){if(this.settings.get("simple")&&this.layers.length){throw new Error('You can create only one layer in "Simple" mode')}var t=new l.Layer(this,e);this.layers.push(t);return t},tick:function(t){e.array.invoke(this.layers,"tick",t)}});var l=f.App;var c=s("LibCanvas.App.Behavior",{eventName:null,initialize:function(e,t){this.element=e;this.events=e.events;this.eventArgs(t)},started:false,changeStatus:function(e){if(this.started==e){return false}else{this.started=e;return true}},eventArgs:function(t){if(this.eventName&&e.core.isFunction(t)){this.events.add(this.eventName,t)}return this},getMouse:function(e,t){var n=this.element.layer.app.resources.get(e?"mouseHandler":"mouse");if(t&&!n){throw new Error("No mouse in element")}return n}});var h=s("LibCanvas.App.Clickable",l.Behavior,{eventName:"statusChange",callbacks:{mousedown:function(e){h.setValue(this,"active",true,e)},mouseup:function(e){h.setValue(this,"active",false,e)},mouseover:function(e){h.setValue(this,"hover",true,e)},mouseout:function(e){h.setValue(this,"hover",false,e);h.setValue(this,"active",false,e)}},start:function(e){if(this.changeStatus(true)){this.eventArgs(e);this.events.add(this.callbacks)}return this},stop:function(){if(this.changeStatus(false)){this.events.remove(this.callbacks)}return this}});h.setValue=function(e,t,n,r){if(e[t]!=n){e[t]=n;e.events.fire(h.prototype.eventName,[t,n,r])}};s("LibCanvas.App.Container",{currentSize:null,doms:[],wrapper:null,bounds:null,initialize:function(e){this.doms=[];this.settings=new a(e);this.currentSize=new m(this.settings.get("size")||[0,0]);this.isSimple=this.settings.get("simple");if(this.isSimple){this.createWrappersSimple()}else{this.createWrappers()}},get rectangle(){var e=this.size;return new w(0,0,e.width,e.height)},set size(e){if(this.isSimple){this.doms[0].size=e}else{e=this.currentSize.set(e).toObject();this.wrapper.css(e);this.bounds.css(e)}},get size(){return this.currentSize},destroy:function(){if(!this.isSimple){this.wrapper.destroy()}return this},createDom:function(e){var t=new l.Dom(this,e);this.doms.push(t);return t},appendTo:function(e){if(e)this.wrapper.appendTo(e);return this},createWrappersSimple:function(){var t=this.currentSize.toObject();this.wrapper=e.dom(f.buffer(t,true));this.bounds=this.wrapper;this.wrapper.addClass("libcanvas-app-simple").appendTo(this.settings.get("appendTo"))},createWrappers:function(){var t=this.currentSize.toObject();this.wrapper=e.dom.create("div").css(t).addClass("libcanvas-app").appendTo(this.settings.get("appendTo"));this.bounds=e.dom.create("div").css({overflow:"hidden",position:"absolute"}).css(t).appendTo(this.wrapper)}});s("LibCanvas.App.Dom",{currentSize:null,container:null,shift:null,z:0,initialize:function(e,t){this.container=e;this.settings=new a(t);this.shift=new d(0,0);this.name=this.settings.get("name")||"";this.createSize();this.createElement()},set zIndex(e){this.z=e;if(!this.container.isSimple){this.element.css("zIndex",e)}},get zIndex(){return this.z},set size(e){e=this.currentSize.set(e);this.canvas.width=e.width;this.canvas.height=e.height},get size(){return this.currentSize},destroy:function(){this.element.destroy();this.size=new m(0,0)},addShift:function(e){var t=this.getShift().move(e);this.element.css({marginLeft:t.x,marginTop:t.y});return this},setShift:function(e){return this.addShift(this.shift.diff(e))},getShift:function(){if(this.container.isSimple){throw new Error("Shift not available in Simple mode")}return this.shift},createSize:function(){var e=this.settings.get("size");if(this.container.isSimple){this.currentSize=this.container.size;if(e){this.currentSize.set(e)}}else{this.currentSize=e||this.container.size.clone()}},createElement:function(){if(this.container.isSimple){this.createElementSimple()}else{this.createElementNormal()}},createElementNormal:function(){this.canvas=new f.Buffer(this.size,true);this.element=e.dom(this.canvas);this.element.attr({"data-name":this.name}).css({position:"absolute"}).appendTo(this.container.bounds);this.zIndex=this.settings.get("zIndex")||0},createElementSimple:function(){this.element=this.container.wrapper;this.canvas=this.element.first;this.canvas.width=this.size.width;this.canvas.height=this.size.height}});s("LibCanvas.App.Draggable",l.Behavior,{eventName:"moveDrag",stopDrag:["up","out"],initialize:function B(e,t){this.bindMethods(["onStop","onDrag","onStart"]);B.previous.call(this,e,t)},start:function(e){if(this.changeStatus(true)){this.mouse=this.getMouse(false,true);this.eventArgs(e);this.events.add("mousedown",this.onStart)}return this},stop:function(){if(this.changeStatus(false)){this.events.remove("mousedown",this.onStart)}return this},bindMouse:function(e){var t=this.mouse,n=this.stopDrag;t.events[e]("move",this.onDrag)[e](n,this.onStop);return t},onStart:function(e){if(e.button!==0)return;this.bindMouse("add");this.events.fire("startDrag",[e])},onDrag:function(e){if(!this.element.layer){return this.onStop(e,true)}var t=this.mouse.delta;this.element.distanceMove(t);this.events.fire("moveDrag",[t,e])},onStop:function(e,t){if(e.button===0||t===true){this.bindMouse("remove");this.events.fire("stopDrag",[e])}}});s("LibCanvas.App.LayerShift",{initialize:function(e){this.layer=e;this.shift=new d(0,0);this.elementsShift=new d(0,0)},shift:null,elementsShift:null,addElementsShift:function(e){if(!e){e=this.elementsShift.diff(this.shift)}else{e=d(e)}var t=this.layer.elements,n=t.length;while(n--)t[n].addShift(e);this.elementsShift.move(e);return this},limitShift:null,setLimitShift:function(e){this.limitShift=e?w(e):null;return this},addShift:function(t,n){t=new d(t);var r=this.limitShift,i=this.shift;if(r){t.x=e.number.limit(t.x,r.from.x-i.x,r.to.x-i.x);t.y=e.number.limit(t.y,r.from.y-i.y,r.to.y-i.y)}i.move(t);this.layer.dom.addShift(t);this.layer.dom.canvas.ctx.translate(t,true);if(n)this.addElementsShift(t);return this},setShift:function(e,t){return this.addShift(this.shift.diff(e),t)},getShift:function(){return this.shift}});s("LibCanvas.App.Dragger",{initialize:function(e){this.bindMethods(["dragStart","dragStop","dragMove"]);this.events=new u(this);this.mouse=e;this.shifts=[];this._events={down:this.dragStart,up:this.dragStop,out:this.dragStop,move:this.dragMove}},addLayerShift:function(e){this.shifts.push(e);return this},started:false,start:function(e){if(e!==n){this.callback=e}this.started=true;this.mouse.events.add(this._events);return this},stop:function(){this.started=false;this.mouse.events.remove(this._events);return this},dragStart:function(e){if(!this.shouldStartDrag(e))return;for(var t=this.shifts.length;t--;){this.shifts[t].layer.stop()}this.drag=true;this.events.fire("start",[e])},dragStop:function(e){if(!this.drag)return;for(var t=this.shifts.length;t--;){var n=this.shifts[t];n.addElementsShift();n.layer.start()}this.drag=false;this.events.fire("stop",[e])},dragMove:function(e){if(!this.drag)return;for(var t=this.shifts.length;t--;){this.shifts[t].addShift(this.mouse.delta)}},shouldStartDrag:function(e){if(!this.started)return false;return this.callback?this.callback(e):true}});s("LibCanvas.App.Element",{layer:null,zIndex:0,renderer:null,settings:{},opacity:1,opacityThreshold:.01,initialize:function(e,t){this.bindMethods(["redraw","destroy"]);this.events=new u(this);this.settings=(new a({hidden:false})).set(this.settings).set(t).addEvents(this.events);e.addElement(this);var n=this.shape&&this.shape!=this.constructor.prototype.shape;if(n||this.settings.get("shape")){if(!n)this.shape=this.settings.get("shape");this.saveCurrentBoundingShape()}if(this.settings.get("zIndex")!=null){this.zIndex=Number(this.settings.get("zIndex"))}this.configure()},configure:function(){return this},previousBoundingShape:null,get currentBoundingShape(){return this.shape.getBoundingRectangle().fillToPixel()},redraw:function(){if(this.layer){this.layer.redrawElement(this)}return this},destroy:function(){if(this.layer){this.layer.rmElement(this)}return this},distanceMove:function(e){this.shape.move(e);return this},hasPoint:function(e){return this.shape.hasPoint(e)},isTriggerPoint:function(e){if(this.hasMousePoint){return this.hasMousePoint(e)}else{return this.hasPoint(e)}},addShift:function(e){this.shape.move(e);if(this.previousBoundingShape)this.previousBoundingShape.move(e);return this},isVisible:function(){return!this.settings.get("hidden")&&this.opacity>this.opacityThreshold},onUpdate:function(e){return this},clearPrevious:function(e){if(this.previousBoundingShape)e.clear(this.previousBoundingShape);return this},saveCurrentBoundingShape:function(){var e=this.currentBoundingShape;this.previousBoundingShape=e.fillToPixel?e.clone().fillToPixel():e.clone().grow(2);return this},renderToWrapper:function(e,t){if(this.opacity<this.opacityThreshold){return}e.save();if(this.opacity+this.opacityThreshold<1){e.set({globalAlpha:this.opacity})}this.renderTo(e,t);e.restore();return this},renderTo:function(e,t){if(this.renderer){this.renderer.renderTo(e,t)}return this}});s("LibCanvas.App.Layer",{initialize:function(e,t){this.settings=(new a({invoke:e.settings.get("invoke"),intersection:"auto"})).set(t);this.intersection=this.settings.get("intersection");this.redrawAllMode=this.intersection==="all"||this.intersection==="full";this.app=e;this.elements=[];this.redraw=this.redrawAllMode?this.elements:[];this.clear=[];this.createDom()},get ctx(){return this.dom.canvas.ctx},stopped:false,destroy:function(){e.array.invoke(this.elements,"destroy");this.dom.destroy()},hide:function(){this.dom.element.css({display:"none"});return this.stop()},show:function(){this.dom.element.css({display:""});return this.stop()},start:function(){this.stopped=false;return this},stop:function(){this.stopped=true;return this},redrawAll:function(){this.elements.invoke("redraw");return this},tick:function(e){if(this.stopped)return this;if(this.settings.get("invoke")){this.sortElements();this.updateAll(e)}if(this.needUpdate){this.draw();this.needUpdate=false}return this},draw:function(){var t=this.intersection,n=this.dom.canvas.ctx,r=this.app.resources;if(t==="full"){n.clearAll()}else{if(t==="auto"){this.addIntersections()}else if(t==="all"){e.array.invoke(this.clear,"clearPrevious",n,r)}e.array.invoke(this.redraw,"clearPrevious",n,r)}this.drawElements(this.redraw,n,r);if(t==="all"){this.clear.length=0}else if(t!=="full"){this.redraw.length=0}},drawElements:function(t,n,r){e.array.sortBy(t,"zIndex");for(var i=t.length;i--;){this.drawElement(t[i],n,r)}},drawElement:function(e,t,n){if(e.layer==this){e.redrawRequested=false;if(e.isVisible()){e.renderToWrapper(t,n);if(this.intersection!=="full"){e.saveCurrentBoundingShape()}}}},sortElements:function(){e.array.sortBy(this.elements,"zIndex")},updateAll:function(t){e.array.invoke(this.elements,"onUpdate",t,this.app.resources)},needUpdate:false,createDom:function(){this.dom=this.app.container.createDom(this.settings.subset(["name","zIndex","size"]))},addElement:function(e){if(e.layer!=this){if(e.layer){e.layer.rmElement(e)}e.layer=this;this.elements.push(e);this.redrawElement(e)}return this},rmElement:function(t){if(t.layer==this){if(this.intersection==="all"){this.needUpdate=true;this.clear.push(t)}else{this.redrawElement(t)}e.core.eraseOne(this.elements,t);t.layer=null}return this},redrawElement:function(e){if(e.layer==this&&!e.redrawRequested){this.needUpdate=true;e.redrawRequested=true;if(!this.redrawAllMode){this.redraw.push(e)}}return this},addIntersections:function(){var e,t,n=this;for(e=0;e<this.redraw.length;e++){t=this.redraw[e];this.findIntersections(t.previousBoundingShape,t,this.redrawElement);this.findIntersections(t.currentBoundingShape,t,function(e){if(e.zIndex>t.zIndex){n.redrawElement(e)}})}},findIntersections:function(e,t,n){if(!e)return;var r=this.elements.length,i;while(r--){i=this.elements[r];if(i!=t&&i.isVisible()&&i.previousBoundingShape&&i.previousBoundingShape.intersect(e))n.call(this,i)}}});var p=s("LibCanvas.Geometry",{initialize:function(){if(arguments.length)this.set.apply(this,arguments)},cast:function(e){return this.constructor.castArguments(e)}}).own({invoke:s.castArguments,from:function(e){return this(e)}});var d=f.declare("LibCanvas.Point","Point",p,{x:0,y:0,set:function(t,n){if(arguments.length!=2){if(e.core.isArrayLike(t)){n=t[1];t=t[0]}else if(t&&t.x!=null&&t.y!=null){n=t.y;t=t.x}else{throw new TypeError("Wrong Arguments In Point.Set")}}this.x=Number(t);this.y=Number(n);return this},move:function(e,t){e=this.cast(e);t=t?-1:1;this.x+=e.x*t;this.y+=e.y*t;return this},moveTo:function(e){return this.move(this.diff(this.cast(e)))},angleTo:function(n){var r=this.cast(n).diff(this);return e.math.normalizeAngle(t.atan2(r.y,r.x))},distanceTo:function(t){var n=this.cast(t).diff(this);return e.math.hypotenuse(n.x,n.y)},checkDistanceTo:function(e,n,r){var i,s,o,u;i=t.abs(this.x-e.x);if(i>n)return false;s=t.abs(this.y-e.y);if(s>n)return false;o=i*i+s*s;u=n*n;return o<u||r&&o==u},diff:function(e){return(new this.constructor(e)).move(this,true)},rotate:function(e,n){n=n?this.cast(n):new this.constructor(0,0);if(this.equals(n))return this;var r=n.distanceTo(this);var i=n.diff(this);var s=t.atan2(i.x,i.y)-e;return this.moveTo({x:t.sin(s)*r+n.x,y:t.cos(s)*r+n.y})},scale:function(e,t){t=t?this.cast(t):new this.constructor(0,0);var n=this.diff(t),r=typeof e=="object";return this.moveTo({x:t.x-n.x*(r?e.x:e),y:t.y-n.y*(r?e.y:e)})},alterPos:function(e,t){return this.moveTo({x:t(this.x,typeof e=="object"?e.x:e),y:t(this.y,typeof e=="object"?e.y:e)})},mul:function(e){return this.alterPos(e,function(e,t){return e*t})},getNeighbour:function(e){return this.clone().move(this.constructor.shifts[e])},get neighbours(){return this.getNeighbours(true)},getNeighbours:function(e,t){var n=["t","l","r","b"],r,i,s;if(e)n.push("tl","tr","bl","br");if(t){r={};for(i=n.length;i--;){s=n[i];r[s]=this.getNeighbour(s)}return r}else{return n.map(this.getNeighbour.bind(this))}},equals:function(t,n){t=this.cast(t);if(n==null){return t.x==this.x&&t.y==this.y}return e.number.equals(this.x,t.x,n)&&e.number.equals(this.y,t.y,n)},toObject:function(){return{x:this.x,y:this.y}},toArray:function(){return[this.x,this.y]},invoke:function(e){this.x=this.x[e]();this.y=this.y[e]();return this},map:function(e,t){this.x=e.call(t||this,this.x,"x",this);this.y=e.call(t||this,this.y,"y",this);return this},mean:function(e){var t=e.length,n=t,r=0,i=0;while(n--){r+=e[n].x;i+=e[n].y}return this.set(r/t,i/t)},snapToPixel:function(){this.x+=.5-(this.x-t.floor(this.x));this.y+=.5-(this.y-t.floor(this.y));return this},reverse:function(){this.x*=-1;this.y*=-1;return this},clone:function(){return new this.constructor(this)},dump:function(){return"[Point("+this.x+", "+this.y+")]"}});d.from=function(e){if(e==null)return null;return e instanceof d?e:new d(e)};d.shifts=e.object.map({top:[0,-1],right:[1,0],bottom:[0,1],left:[-1,0],t:[0,-1],r:[1,0],b:[0,1],l:[-1,0],tl:[-1,-1],tr:[1,-1],bl:[-1,1],br:[1,1]},d);var v=f.declare("LibCanvas.Mouse","Mouse",{elem:null,inside:false,point:null,previous:null,delta:null,events:null,mapping:{click:"click",dblclick:"dblclick",contextmenu:"contextmenu",mouseover:"over",mouseout:"out",mousedown:"down",mouseup:"up",mousemove:"move",DOMMouseScroll:"wheel",mousewheel:"wheel"},initialize:function(t,n){this.bindMethods("onEvent");if(t==null){throw new TypeError("`elem` is undefined")}this.elem=e.dom(t);this.offsetElem=n?e.dom(n):this.elem;this.point=new d(0,0);this.previous=new d(0,0);this.delta=new d(0,0);this.events=new u(this);this.listen(this.onEvent)},fire:function(e,t){this.events.fire(e,[t,this]);return this},onEvent:function(e){var t=this.mapping[e.type],n=this.eventActions[t];if(n)n.call(this,e);this.fire(t,e)},getOffset:function(e){return this.constructor.getOffset(e,this.offsetElem)},set:function(e,t){var n=this.getOffset(e);this.previous.set(this.point);this.delta.set(this.previous.diff(n));this.point.set(n);this.inside=t},eventActions:{wheel:function(e){this.constructor.addWheelDelta(e)},move:function(e){this.set(e,true)},down:function(e){this.set(e,true)},over:function(e){if(this.checkEvent(e)){this.fire("enter",e)}},out:function(e){if(this.checkEvent(e)){this.set(e,false);this.fire("leave",e)}}},checkEvent:function(e){var t=e.relatedTarget,n=this.elem;return t==null||t&&t!=n.first&&!n.contains(t)},listen:function(t){this.elem.bind({selectstart:false}).bind(e.object.map(this.mapping,e.fn.lambda(t)))}}).own({prevent:function(e){e.preventDefault()},addWheelDelta:function(e){e.delta=e.wheelDelta?e.wheelDelta>0?1:-1:e.detail?e.detail<0?1:-1:null;return e},eventSource:function(e){return e.changedTouches?e.changedTouches[0]:e},expandEvent:function(e){var t=this.eventSource(e);if(e.pageX==null){e.pageX=t.pageX!=null?t.pageX:t.clientX+document.scrollLeft;e.pageY=t.pageY!=null?t.pageY:t.clientY+document.scrollTop}return e},getOffset:function(t,n){var r=e.dom(n||this.eventSource(t).target).offset();this.expandEvent(t);return new d(t.pageX-r.x,t.pageY-r.y)}});s("LibCanvas.App.PointSearch",{initialize:function(){this.elements=[]},add:function(e){this.elements.push(e);return this},remove:function(t){e.core.eraseOne(this.elements,t);return this},removeAll:function(){this.elements.length=0;return this},findByPoint:function(e){var t=this.elements,n=t.length,r=[];while(n--)if(t[n].isTriggerPoint(e)){r.push(t[n])}return r}});l.ElementsMouseSearch=l.PointSearch;s("LibCanvas.App.MouseHandler",{events:"down up move out dblclick contextmenu wheel".split(" "),mouse:null,initialize:function(e){var t=this;t.settings=new a(e);t.lastMouseMove=[];t.lastMouseDown=[];t.subscribers=[];t.app=t.settings.get("app");t.mouse=t.settings.get("mouse");t.compareFunction=function(e,n){return t.app.zIndexCompare(e,n,true)};t.search=t.settings.get("search")||new l.PointSearch;this.events.forEach(function(e){t.mouse.events.add(e,function(n){t.event(e,n)})})},stop:function(){this.stopped=true;return this},start:function(){this.stopped=false;return this},subscribe:function(e){if(this.subscribers.indexOf(e)==-1){this.subscribers.push(e);this.search.add(e)}return this},unsubscribe:function(t){var n=this.subscribers.indexOf(t);if(n!=-1){this.subscribers.splice(n,1);e.core.eraseOne(this.lastMouseDown,t);e.core.eraseOne(this.lastMouseMove,t);this.search.remove(t)}return this},unsubscribeAll:function(){this.subscribers.length=0;this.search.removeAll();return this},fall:function(){this.falling=true;return this},getOverElements:function(){if(!this.mouse.inside)return[];var e=this.search.findByPoint(this.mouse.point),t=e.length;while(t--)if(!e[t].layer){this.unsubscribe(e[t]);e.splice(t,1)}return e.sort(this.compareFunction)},stopped:false,falling:false,checkFalling:function(){var e=this.falling;this.falling=false;return e},event:function(e,t){if(this.stopped)return;var n=["dblclick","contextmenu","wheel"].indexOf(e)>=0?"forceEvent":"parseEvent";return this[n](e,t)},parseEvent:function(e,t){if(e=="down")this.lastMouseDown.length=0;var n,r,i=this.getOverElements(),s=false,o=[t],u=e=="move"||e=="out";if(u){this.informOut(o,i)}for(n=i.length;n--;){r=i[n];if(!s){if(this.fireElem(e,r,o)){s=true;if(!u)break}}else{this.stoppedElem(r,o)}}return s},informOut:function(e,t){var n,r=this.lastMouseMove,i=r.length;while(i--){n=r[i];if(t.indexOf(n)<0){n.events.fire("mouseout",e);r.splice(i,1)}}},stoppedElem:function(e,t){var n=this.lastMouseMove,r=n.indexOf(e);if(r>-1){e.events.fire("mouseout",t);n.splice(r,1)}},fireElem:function(e,t,n){var r=this.lastMouseDown,i=this.lastMouseMove;if(e=="move"){if(i.indexOf(t)<0){t.events.fire("mouseover",n);i.push(t)}}else if(e=="down"){r.push(t)}else if(e=="up"&&r.indexOf(t)>-1){t.events.fire("click",n)}t.events.fire("mouse"+e,n);return!this.checkFalling()},forceEvent:function(e,t){var n=this.getOverElements(),r=n.length;while(r--){n[r].events.fire(e,[t]);if(!this.checkFalling()){break}}}});var m=f.declare("LibCanvas.Size","Size",d,{set:function j(e){if(typeof e=="object"&&e.width!=null){this.x=Number(e.width);this.y=Number(e.height);return this}return j.previous.apply(this,arguments)},get width(){return this.x},get height(){return this.y},set width(e){this.x=e},set height(e){this.y=e},toObject:function(){return{width:this.x,height:this.y}}});m.from=function(e){if(e==null)return null;return e instanceof m?e:new m(e)};var g=function(){if(!g.buffer){return g.buffer=f.buffer(1,1,true)}return g.buffer};var y=s("LibCanvas.Shape",p,{set:"abstract",hasPoint:"abstract",processPath:"abstract",draw:function(e,t){this.processPath(e)[t]();return this},getCoords:function(){return this.from},grow:function(e){if(typeof e=="number"){e=new d(e/2,e/2)}else{e=new d(e.x/2,e.y/2)}this.from.move(e,true);this.to.move(e);return this},get x(){return this.from.x},get y(){return this.from.y},set x(e){return this.move(new d(e-this.x,0))},set y(e){return this.move(new d(0,e-this.y))},get bottomLeft(){return new d(this.from.x,this.to.y)},get topRight(){return new d(this.to.x,this.from.y)},get center(){var e=this.from,t=this.to;return new d((e.x+t.x)/2,(e.y+t.y)/2)},getBoundingRectangle:function(){return new w(this.from,this.to)},getCenter:function(){return this.center},move:function(e,t){this.from.move(e,t);this.to.move(e,t);return this},equals:function(e,t){return e instanceof this.constructor&&e.from.equals(this.from,t)&&e.to.equals(this.to,t)},clone:function(){return new this.constructor(this.from.clone(),this.to.clone())},dumpPoint:function(e){return"["+e.x+", "+e.y+"]"},dump:function(e){if(!e)return this.toString();return"[shape "+e+"(from"+this.dumpPoint(this.from)+", to"+this.dumpPoint(this.to)+")]"}});var b=new d(-1,-1);var w=f.declare("LibCanvas.Shapes.Rectangle","Rectangle",y,{set:function(){var t,n,r=e.array.pickFrom(arguments),i=r[0];this.from=null;this.to=null;if(r.length==4){this.from=new d(r[0],r[1]);this.to=new d(r[0]+r[2],r[1]+r[3])}else if(r.length==2){if("width"in r[1]&&"height"in r[1]){this.set({from:r[0],size:r[1]})}else{this.from=d.from(r[0]);this.to=d.from(r[1])}}else if(i.center&&i.size){t=d.from(i.center);n=m.from(i.size);this.from=new d(t.x-n.x/2,t.y-n.y/2);this.to=new d(t.x+n.x/2,t.y+n.y/2)}else{if(i.from)this.from=d.from(i.from);if(i.to)this.to=d.from(i.to);if(!this.from||!this.to&&i.size){n=m.from(i.size);if(this.from){this.to=new d(this.from.x+n.x,this.from.y+n.y)}else{this.from=new d(this.to.x-n.x,this.to.y-n.y)}}}return this},get width(){return this.to.x-this.from.x},get height(){return this.to.y-this.from.y},set width(e){this.to.x=this.from.x+e},set height(e){this.to.y=this.from.y+e},get size(){return new m(this.width,this.height)},set size(e){this.to.set(this.from.x+e.width,this.from.y+e.height)},hasPoint:function(n,r){n=d.from(n);r=r||0;return n.x!=null&&n.y!=null&&e.number.between(n.x,t.min(this.from.x,this.to.x)+r,t.max(this.from.x,this.to.x)-r,"L")&&e.number.between(n.y,t.min(this.from.y,this.to.y)+r,t.max(this.from.y,this.to.y)-r,"L")},align:function(e,t){if(t==null)t="center middle";var n=this.from.clone();if(t.indexOf("left")!=-1){n.x=e.from.x}else if(t.indexOf("center")!=-1){n.x=e.from.x+(e.width-this.width)/2}else if(t.indexOf("right")!=-1){n.x=e.to.x-this.width}if(t.indexOf("top")!=-1){n.y=e.from.y}else if(t.indexOf("middle")!=-1){n.y=e.from.y+(e.height-this.height)/2}else if(t.indexOf("bottom")!=-1){n.y=e.to.y-this.height}return this.moveTo(n)},moveTo:function(e){if(e instanceof d){this.move(this.from.diff(e))}else{e=w.from(e);this.from.moveTo(e.from);this.to.moveTo(e.to)}return this},draw:function(e,n){e.original(n+"Rect",[t.min(this.from.x,this.to.x),t.min(this.from.y,this.to.y),t.abs(this.width),t.abs(this.height)]);return this},processPath:function(e,t){if(!t)e.beginPath();e.ctx2d.rect(this.from.x,this.from.y,this.width,this.height);if(!t)e.closePath();return e},intersect:function(e){if(e.prototype!=this.constructor){if(e.getBoundingRectangle){e=e.getBoundingRectangle()}else return false}return this.from.x<e.to.x&&this.to.x>e.from.x&&this.from.y<e.to.y&&this.to.y>e.from.y},getBoundingRectangle:function(){return this},getRandomPoint:function(t){t=t||0;return new d(e.number.random(t,this.width-t),e.number.random(t,this.height-t))},fillToPixel:function(){var e=this.from,n=this.to,r=function(r,i){return new d(t[i](t[r](e.x,n.x)),t[i](t[r](e.y,n.y)))};return new w(r("min","floor"),r("max","ceil"))},snapToPixel:function(){this.from.snapToPixel();this.to.snapToPixel().move(b);return this},dump:function F(e){return F.previous.call(this,e||"Rectangle")},toPolygon:function(){return new O(this.from.clone(),this.topRight,this.to.clone(),this.bottomLeft)}});w.from=function(e){if(e==null)return null;return e instanceof w?e:new w(e)};var E=f.declare("LibCanvas.Shapes.Circle","Circle",y,{set:function(){var t,n,r=e.array.pickFrom(arguments);if(r.length>=3){t=new d(r[0],r[1]);n=r[2]}else if(r.length==2){t=d.from(r[0]);n=r[1]}else{r=r[0];n=r.r==null?r.radius:r.r;if("x"in r&&"y"in r){t=new d(r.x,r.y)}else if("center"in r){t=d.from(r.center)}else if("from"in r){t=(new d(r.from)).move({x:this.radius,y:this.radius})}}this.center=t;this.radius=n;if(t==null)throw new TypeError("center is null");if(n==null)throw new TypeError("radius is null")},get center(){return this._center},set center(e){this._center=e},grow:function(e){this.radius+=e/2;return this},getCoords:function(){return this.center},hasPoint:function(e){return this.center.checkDistanceTo(e,this.radius,true)},scale:function(e,t){if(t)this.center.scale(e,t);this.radius*=e;return this},getCenter:function(){return this.center},intersect:function(e){if(e instanceof this.constructor){return this.center.checkDistanceTo(e.center,this.radius+e.radius,true)}else{return this.getBoundingRectangle().intersect(e)}},move:function(e,t){this.center.move(e,t);return this},processPath:function(e,n){if(!n)e.beginPath();if(this.radius){e.arc({circle:this,angle:[0,t.PI*2]})}if(!n)e.closePath();return e},getBoundingRectangle:function(){var e=this.radius,t=this.center;return new w(new d(t.x-e,t.y-e),new d(t.x+e,t.y+e))},clone:function(){return new this.constructor(this.center.clone(),this.radius)},getPoints:function(){return{center:this.center}},equals:function(e,t){return e instanceof this.shape&&e.radius==this.radius&&e.center.equals(this.center,t)},dump:function(){return"[shape Circle(center["+this.center.x+", "+this.center.y+"], "+this.radius+")]"}});E.from=function(e){if(e==null)return null;return e instanceof E?e:new E(e)};e.core.append(HTMLCanvasElement,{_newContexts:{},addContext:function(e,t){this._newContexts[e]=t;return this},getContext:function(e){return this._newContexts[e]||null}});e.core.append(HTMLCanvasElement.prototype,{getOriginalContext:HTMLCanvasElement.prototype.getContext,getContext:function(e){if(!this.contextsList){this.contextsList={}}if(!this.contextsList[e]){var t=HTMLCanvasElement.getContext(e);if(t){t=new t(this)}else try{t=this.getOriginalContext.apply(this,arguments)}catch(n){throw!n.toString().match(/NS_ERROR_ILLEGAL_VALUE/)?n:new TypeError("Wrong Context Type: «"+e+"»")}this.contextsList[e]=t}return this.contextsList[e]}});new function(){var n=d.from,r=w.from;f.declare("LibCanvas.Context.DrawImage",{initialize:function(e){this.context=e;this.ctx2d=e.ctx2d},drawImage:function(t){var i,s,o,u,a,f,l,c,h;if(this.checkNonObject(t))return;i=t[0];l=i.image;h=i.angle;f=i.scale&&n(i.scale);s=i.center&&n(i.center);o=i.from&&n(i.from);u=i.draw&&r(i.draw);a=i.crop&&r(i.crop);if(!e.dom.isElement(l))throw new TypeError("Wrong image in Context.DrawImage");if(!(s||o||u))throw new TypeError("Wrong arguments in Context.DrawImage");c=this.getTransformPivot(h,f,l,s,o,u);if(c)this.transform(c,h,f);u?this.drawRect(l,u,a,i.optimize):this.drawPoint(l,o,s,i.optimize);if(c)this.ctx2d.restore();return this.context},run:function(e){this.ctx2d.drawImage.apply(this.ctx2d,e)},transform:function(e,t,n){this.ctx2d.save();if(t)this.context.rotate(t,e);if(n)this.context.scale(n,e)},checkNonObject:function(t){var n=t[0],r=t.length,i;if(r>2){this.run(t);return true}if(r==2){i=t[1];if(i instanceof d){this.drawPoint(n,i);return true}if(i instanceof w){this.drawRect(n,i);return true}throw new Error("Unknown second argument in Context.DrawImage")}if(r==0){throw new Error("Empty arguments in Context.DrawImage")}if(e.dom.isElement(n)){this.ctx2d.drawImage(n,0,0);return true}return false},drawPoint:function(e,n,r,i){var s=r||n,o=s.x,u=s.y;if(r){o-=e.width/2;u-=e.height/2}if(i){o=t.round(o);u=t.round(u)}this.ctx2d.drawImage(e,o,u)},drawRect:function(e,n,r,i){var s,o,u,a;if(r){this.ctx2d.drawImage(e,r.from.x,r.from.y,r.width,r.height,n.from.x,n.from.y,n.width,n.height);return}if(i){u=t.round(n.from.x);a=t.round(n.from.y);s=t.abs(n.width-e.width);o=t.abs(n.height-e.width);if(s<1.1&&o<1.1){this.ctx2d.drawImage(e,u,a)}else{this.ctx2d.drawImage(e,u,a,t.round(n.width),t.round(n.height))}return}this.ctx2d.drawImage(e,n.from.x,n.from.y,n.width,n.height)},getTransformPivot:function(e,t,n,r,i,s){if(!e&&(!t||t.x==1&&t.y==1))return null;if(r)return r;if(s)return s.center;return new d(i.x+n.width/2,i.y+n.height/2)}})};new function(){var e=d.from,t=w.from,n=E.from;var r=document.createElement("canvas").getContext("2d").createLinearGradient(0,0,1,1).addColorStop;var i=function(e){if(typeof e=="object"){for(var t in e)if(e.hasOwnProperty(t)){r.call(this,parseFloat(t),e[t])}}else{r.apply(this,arguments)}return this};var s=function(e){e.addColorStop=i;return e};f.declare("LibCanvas.Context.Gradients",{initialize:function(e){this.context=e;this.ctx2d=e.ctx2d},createGradient:function(e,t,n){var r;if(e instanceof w){n=t;r=this.createLinearGradient([e])}else if(e instanceof E){r=this.createRadialGradient([e,t])}else if(e instanceof d){r=this.createLinearGradient([e,t])}else{throw new Error("Unknown arguments in Context.Gradients.createGradient")}if(typeof n=="object")r.addColorStop(n);return r},createRectangleGradient:function(e,n){e=t(e);var r=e.from,i=new A(e.bottomLeft,e.topRight);return this.createGradient(r,i.perpendicular(r).scale(2,r),n)},createLinearGradient:function(t){var n,r;if(t.length!=4){if(t.length==2){r=e(t[0]);n=e(t[1])}else if(t.length==1){r=e(t[0].to);n=e(t[0].from)}else{throw new TypeError("Wrong arguments.length in the Context.createLinearGradient")}t=[n.x,n.y,r.x,r.y]}return s(this.ctx2d.createLinearGradient.apply(this.ctx2d,t))},createRadialGradient:function(e){var t,r,i,o=e.length;if(o==1||o==2){if(o==2){r=n(e[0]);i=n(e[1])}else{r=n(e.start);i=n(e.end)}t=[r.center.x,r.center.y,r.radius,i.center.x,i.center.y,i.radius]}else if(o==6){t=e}else{throw new TypeError("Wrong arguments.length in the Context.createRadialGradient")}return s(this.ctx2d.createRadialGradient.apply(this.ctx2d,t))}})};new function(){var t=d.from,n=E.from;f.declare("LibCanvas.Context.Path",{initialize:function(e){this.context=e;this.ctx2d=e.ctx2d},arc:function(e){if(e.length>1){return this.ctx2d.arc.apply(this.ctx2d,e)}else if(!e[0].circle){throw new TypeError("Wrong arguments in CanvasContext.arc")}var t=e[0],r,i,s,o,u;r=n(t.circle);i=t.angle;if(Array.isArray(i)){s=i[0];o=i[1]}else{s=i.start;o=i.end;u=i.size;if(u==null){}else if(o==null){o=u+s}else if(s==null){s=o-u}}this.ctx2d.arc(r.center.x,r.center.y,r.radius,s,o,!!(t.anticlockwise||t.acw));return this.context},arcTo:function(){this.ctx2d.arcTo.apply(this.ctx2d,arguments);return this.context},curveTo:function(n){var r,i,s,o=n[0];if(typeof o=="number"){if(n.length===4){return this.quadraticCurveTo(n)}else if(n.length===6){return this.bezierCurveTo(n)}}else if(n.length>1){r=e.array.from(n).map(t);s=r.shift()}else{r=e.array.from(o.points).map(t);s=t(o.to)}i=r.length;if(i==2){this.ctx2d.bezierCurveTo(r[0].x,r[0].y,r[1].x,r[1].y,s.x,s.y)}else if(i==1){this.ctx2d.quadraticCurveTo(r[0].x,r[0].y,s.x,s.y)}else{this.ctx2d.lineTo(s.x,s.y)}return this.context},quadraticCurveTo:function(e){if(e.length==4){this.ctx2d.quadraticCurveTo.apply(this.ctx2d,e);return this.context}else{e=e.length==2?{p:e[0],to:e[1]}:e[0];return this.curveTo([{to:e.to,points:[e.p]}])}},bezierCurveTo:function(e){if(e.length==6){this.ctx2d.bezierCurveTo.apply(this.ctx2d,e);return this.context}else{e=e.length==3?{p1:e[0],p2:e[1],to:e[2]}:e[0];return this.curveTo([{to:e.to,points:[e.p1,e.p2]}])}},isPointInPath:function(e,n){if(n==null){e=t(e);n=e.y;e=e.x}return this.ctx2d.isPointInPath(e,n)}})};new function(){var t=d.from,n=w.from,r=new m(1,1);f.declare("LibCanvas.Context.Pixels",{initialize:function(e){this.context=e;this.ctx2d=e.ctx2d},createImageData:function(e,t){if(e==null){e=this.context.width;t=this.context.height}else if(t==null){if(e.width==null&&e.height==null){throw new TypeError("Wrong argument in the Context.createImageData")}else{t=e.height;e=e.width}}return this.ctx2d.createImageData(e,t)},putImageData:function(r){var i={},s,o;switch(r.length){case 1:{if(typeof r!="object"){throw new TypeError("Wrong argument in the Context.putImageData")}r=r[0];i.image=r.image;i.from=t(r.from);if(r.crop)i.crop=n(r.crop)}break;case 3:{i.image=r[0];i.from=new d(r[1],r[2])}break;case 7:{i.image=r[0];i.from=new d(r[1],r[2]);i.crop=new w(r[3],r[4],r[5],r[6])}break;default:throw new TypeError("Wrong args number in the Context.putImageData")}s=[i.image,i.from.x,i.from.y];if(i.crop){o=i.crop;e.array.append(s,[o.from.x,o.from.y,o.width,o.height])}this.ctx2d.putImageData.apply(this.ctx2d,s);return this.context},getImageData:function(e){var t=n(e.length>1?e:e[0]);return this.ctx2d.getImageData(t.from.x,t.from.y,t.width,t.height)},getPixels:function(e){var t=n(e.length>1?e:e[0]),r=this.getImageData(t).data,i=[],s=[];for(var o=0,u=r.length;o<u;o+=4){s.push({r:r[o],g:r[o+1],b:r[o+2],a:r[o+3]/255});if(s.length==t.width){i.push(s);s=[]}}return i},getPixel:function(n){var s=new w(t(n),r),o=i.call(this.getImageData([s]).data);o[3]/=255;return new e.Color(o)}})};new function(){var n=d.from,r=w.from,i=new m(1,1);f.declare("LibCanvas.Context.Text",{initialize:function(e){this.context=e;this.ctx2d=e.ctx2d},method:function(e,t,r,i,s){var o=typeof r;if(o!="number"&&o!="string"){s=i;r=n(r);i=r.y;r=r.x}var u=[t,r,i];if(s)u.push(s);this.ctx2d[e].apply(this.ctx2d,u);return this.context},fillText:function(e,t,n,r){return this.method("fillText",e,t,n,r)},strokeText:function(e,t,n,r){return this.method("strokeText",e,t,n,r)},measureText:function(e){return this.ctx2d.measureText.call(this.ctx2d,e)},text:function(n){function a(e){var r=n.align,i=n.padding[1];return t.round(r=="left"?o.from.x+i:r=="right"?o.to.x-e-i:o.from.x+(o.width-e)/2)}function f(e){return Number(i.measureText(e).width)}if(!this.ctx2d.fillText)return this;var i=this.ctx2d;n=e.core.append({text:"",color:null,wrap:"normal",to:null,align:"left",size:16,weight:"normal",style:"normal",family:"arial,sans-serif",lineHeight:null,overflow:"visible",padding:[0,0],shadow:null,stroke:null,lineWidth:null},n);i.save();if(typeof n.padding=="number"){n.padding=[n.padding,n.padding]}var s=n.stroke?"strokeText":"fillText";var o=n.to?r(n.to):this.context.rectangle;var u=t.round(n.lineHeight||n.size*1.15);this.context.set("font",e.string.substitute("{style}{weight}{size}px {family}",{style:n.style=="italic"?"italic ":"",weight:n.weight=="bold"?"bold ":"",size:n.size,family:n.family}));if(n.color){this.context.set(n.stroke?"strokeStyle":"fillStyle",n.color)}if(n.shadow)this.context.shadow=n.shadow;if(n.overflow=="hidden")this.context.clip(o);if(n.lineWidth)this.context.set({lineWidth:n.lineWidth});var l=String(n.text).split("\n");if(n.wrap=="no"){l.forEach(function(e,t){if(!e)return;i[s](e,a(n.align=="left"?0:f(e)),o.from.y+(t+1)*u)})}else{var c=0;l.forEach(function(e){if(!e){c++;return}var t=(e||" ").match(/.+?(\s|$)/g);if(!t){c++;return}var r="";var l=0;for(var h=0;h<=t.length;h++){var p=h==t.length;if(!p){var d=t[h];var v=f(d);if(!l||l+v<o.width){l+=v;r+=d;continue}}if(l){i[s](r,a(l),o.from.y+ ++c*u+n.padding[0]);if(p){r="";l=0}else{r=d;l=v}}}if(l){i[s](r,a(l),o.from.y+ ++c*u+n.padding[0])}})}i.restore();return this.context}})};var S=function(){var t={all:function(e,t){this.save();if(t)this.set(e+"Style",t);this[e+"Rect"](this.rectangle);this.restore();return this},rect:function(e,n){var r=t.makeRect.call(this,n);return this.original(e,[r.from.x,r.from.y,r.width,r.height])},makeRect:function(e){return e.length?w(e):this.rectangle},fillStroke:function(e,t){if(t.length>=1&&t[0]instanceof y){if(t[1])this.save().set(e+"Style",t[1]);t[0].draw(this,e);if(t[1])this.restore()}else{if(t.length&&t[0])this.save().set(e+"Style",t[0]);this.original(e);if(t.length&&t[0])this.restore()}return this},originalPoint:function(e,t){var n=d(t);return this.original(e,[n.x,n.y])}};var n=function(){var t=e.dom.create("canvas",{width:15,height:15}).first.getContext("2d");t.shadowBlur=1;t.shadowOffsetX=0;t.shadowOffsetY=-5;t.shadowColor="green";t.fillRect(0,5,5,5);return t.getImageData(0,0,1,1).data[1]<64}();var r={COMPOSITE:{SOURCE_OVER:"source-over",SOURCE_IN:"source-in",SOURCE_OUT:"source-out",SOURCE_ATOP:"source-atop",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",DESTINATION_ATOP:"destination-atop",LIGHTER:"lighter",DARKER:"darker",COPY:"copy",XOR:"xor"},LINE_CAP:{BUTT:"butt",ROUND:"round",SQUARE:"square"},LINE_JOIN:{ROUND:"round",BEVEL:"bevel",MITER:"miter"},TEXT_ALIGN:{LEFT:"left",RIGHT:"right",CENTER:"center",START:"start",END:"end"},TEXT_BASELINE:{TOP:"top",HANGING:"hanging",MIDDLE:"middle",ALPHABETIC:"alphabetic",IDEOGRAPHIC:"ideographic",BOTTOM:"bottom"},SHADOW_BUG:n};var i=f.declare("LibCanvas.Context2D","Context2D",{initialize:function(t){if(t instanceof CanvasRenderingContext2D){this.ctx2d=t;this.canvas=this.ctx2d.canvas}else{this.canvas=t;this.ctx2d=e.core.isFunction(t.getOriginalContext)?t.getOriginalContext("2d"):t.getContext("2d")}this.helpers={image:new f.Context.DrawImage(this),gradients:new f.Context.Gradients(this),pixels:new f.Context.Pixels(this),text:new f.Context.Text(this),path:new f.Context.Path(this)}},get width(){return this.canvas.width},get height(){return this.canvas.height},set width(e){this.canvas.width=e},set height(e){this.canvas.height=e},get size(){return new m(this.width,this.height)},set size(e){e=m.from(e);this.width=e.width;this.height=e.height},get shadow(){return[this.shadowOffsetX,this.shadowOffsetY,this.shadowBlur,this.shadowColor].join(" ")},set shadow(e){e=e.split(" ");this.shadowOffsetX=e[0];this.shadowOffsetY=e[1];this.shadowBlur=e[2];this.shadowColor=e[3]},safeSet:function(e,t){try{this.ctx2d[e]=t}catch(n){throw TypeError("Exception while setting «"+e+"» to «"+t+"»: "+n.message)}},set shadowOffsetY(e){if(n)e*=-1;this.safeSet("shadowOffsetY",e)},set shadowBlur(e){if(n&&e<1)e=1;this.safeSet("shadowBlur",e)},get shadowOffsetY(){return this.ctx2d.shadowOffsetY},get shadowBlur(){return this.ctx2d.shadowBlur},get opacity(){return this.globalAlpha},set opacity(e){this.globalAlpha=e},_rectangle:null,get rectangle(){var e=this._rectangle;if(!e){this._rectangle=e=new w(0,0,this.width,this.height)}else{e.size=this}return e},original:function(e,t,n){var r=this.ctx2d[e].apply(this.ctx2d,t||[]);return n?r:this},getClone:function(e,t){var n=!!(e||t),r=this.canvas;e=e||r.width;t=t||r.height;var i=[r,0,0];if(n)i.push(e,t);var s=f.buffer(e,t,true);s.ctx.original("drawImage",i);return s},set:function(e,t){if(typeof e=="object"){for(var n in e)this[n]=e[n]}else this[e]=t;return this},get:function(e){return this[e]},fillAll:function(e){return t.all.call(this,"fill",e)},strokeAll:function(e){return t.all.call(this,"stroke",e)},clearAll:function(){return this.ctx2d.clearRect(0,0,this.canvas.width,this.canvas.height)},save:function(){this.ctx2d.save();return this},restore:function(){this.ctx2d.restore();return this},fill:function(e){return t.fillStroke.call(this,"fill",arguments)},stroke:function(e){return t.fillStroke.call(this,"stroke",arguments)},clear:function(e,t){return e instanceof y&&e.constructor!=w?this.save().set({globalCompositeOperation:i.COMPOSITE.DESTINATION_OUT})[t?"stroke":"fill"](e).restore():this.clearRect(w.from(e))},beginPath:function(e){var t=this.original("beginPath");arguments.length&&this.moveTo.apply(this,arguments);return t},closePath:function(){arguments.length&&this.lineTo.apply(this,arguments);return this.original("closePath")},moveTo:function(e){return t.originalPoint.call(this,"moveTo",arguments)},lineTo:function(e){return t.originalPoint.call(this,"lineTo",arguments)},arc:function(e,t,n,r,i,s){return this.helpers.path.arc(arguments)},arcTo:function(){return this.helpers.path.arcTo(arguments)},curveTo:function(e){return this.helpers.path.curveTo(arguments)},quadraticCurveTo:function(){return this.helpers.path.quadraticCurveTo(arguments)},bezierCurveTo:function(){return this.helpers.path.bezierCurveTo(arguments)},isPointInPath:function(e,t){return this.helpers.path.isPointInPath(e,t)},clip:function(e){if(e&&typeof e.processPath=="function"){e.processPath(this)}return this.original("clip")},rotate:function(e,t){if(e){if(t)this.translate(t);this.original("rotate",[e]);if(t)this.translate(t,true)}return this},translate:function(e,t){e=d(arguments.length===1||typeof t==="boolean"?e:arguments);var n=t===true?-1:1;this.original("translate",[e.x*n,e.y*n]);return this},scale:function(e,t){if(typeof t=="number"){e=new d(e,t);t=null}else{e=d(e)}if(e.x!=1||e.y!=1){if(t)this.translate(t);this.original("scale",[e.x,e.y]);if(t)this.translate(t,true)}return this},transform:function(){return this.original("transform",arguments)},setTransform:function(){return this.original("setTransform",arguments)},fillRect:function(e){return t.rect.call(this,"fillRect",arguments)},strokeRect:function(e){return t.rect.call(this,"strokeRect",arguments)},clearRect:function(e){return t.rect.call(this,"clearRect",arguments)},fillText:function(e,t,n,r){return this.helpers.text.fillText(e,t,n,r)},strokeText:function(e,t,n,r){return this.helpers.text.strokeText(e,t,n,r)},measureText:function(e){return this.helpers.text.measureText(arguments)},text:function(e){return this.helpers.text.text(e)},drawImage:function(){return this.helpers.image.drawImage(arguments)},createImageData:function(e,t){return this.helpers.pixels.createImageData(e,t)},putImageData:function(){return this.helpers.pixels.putImageData(arguments)},getImageData:function(e){return this.helpers.pixels.getImageData(arguments)},getPixels:function(e){return this.helpers.pixels.getPixels(arguments)},getPixel:function(e){return this.helpers.pixels.getPixel(e)},createGradient:function(e,t,n){return this.helpers.gradients.createGradient(e,t,n)},createRectangleGradient:function(e,t){return this.helpers.gradients.createRectangleGradient(e,t)},createLinearGradient:function(){return this.helpers.gradients.createLinearGradient(arguments)},createRadialGradient:function(){return this.helpers.gradients.createRadialGradient(arguments)},createPattern:function(){return this.original("createPattern",arguments,true)},drawWindow:function(){return this.original("drawWindow",arguments)}}).own(r);["fillStyle","font","globalAlpha","globalCompositeOperation","lineCap","lineJoin","lineWidth","miterLimit","shadowOffsetX","shadowColor","strokeStyle","textAlign","textBaseline"].forEach(function(t){e.accessors.define(i.prototype,t,{set:function(e){this.safeSet(t,e)},get:function(){return this.ctx2d[t]}})});i.office=t;if(e.core.isFunction(HTMLCanvasElement.addContext)){HTMLCanvasElement.addContext("2d-libcanvas",i)}return i}();var x=f.declare("LibCanvas.Point3D","Point3D",p,{x:0,y:0,z:0,coordinatesArray:["x","y","z"],set:function(e,t,n){if(arguments.length>1){this.x=Number(e)||0;this.y=Number(t)||0;this.z=Number(n)||0}else if(e&&typeof e.x==="number"){this.set(e.x,e.y,e.z)}else if(e&&typeof e[0]==="number"){this.set(e[0],e[1],e[2])}else{throw new Error("Wrong arguments in Isometric.Point3D")}return this},map:function(e,t){var n=this;n.coordinatesArray.forEach(function(r){n[r]=e.call(t||n,n[r],r,n)});return this},add:function(e){return this.map(function(t){return t+e})},mul:function(e){return this.map(function(t){return t*e})},diff:function(e){e=this.cast(e);return new this.constructor(e.x-this.x,e.y-this.y,e.z-this.z)},move:function(e){e=this.cast(arguments);this.x+=e.x;this.y+=e.y;this.z+=e.z;return this},equals:function(e,t){return e.x.equals(this.x,t)&&e.y.equals(this.y,t)&&e.z.equals(this.z,t)},clone:function(){return new this.constructor(this)},toArray:function(){return[this.x,this.y,this.z]},dump:function(){return"[LibCanvas.Point3D("+this.toArray()+")]"}});new function(){var t={initialize:function(e){if(e instanceof CanvasRenderingContext2D){this.ctx2d=e;this.canvas=this.ctx2d.canvas}else{this.canvas=e;this.ctx2d=e.getOriginalContext("2d")}},get width(){return this.canvas.width},get height(){return this.canvas.height},set width(e){this.canvas.width=e},set height(e){this.canvas.height=e}},n=("arc arcTo beginPath bezierCurveTo clearRect clip "+"closePath drawImage fill fillRect fillText lineTo moveTo "+"quadraticCurveTo rect restore rotate save scale setTransform "+"stroke strokeRect strokeText transform translate").split(" "),r=("createPattern drawFocusRing isPointInPath measureText "+"createImageData createLinearGradient "+"createRadialGradient getImageData putImageData").split(" "),i=("fillStyle font globalAlpha globalCompositeOperation lineCap "+"lineJoin lineWidth miterLimit shadowOffsetX shadowOffsetY "+"shadowBlur shadowColor strokeStyle textAlign textBaseline").split(" ");i.forEach(function(n){e.accessors.define(t,n,{set:function(e){try{this.ctx2d[n]=e}catch(t){throw TypeError("Exception while setting «"+n+"» to «"+e+"»: "+t.message)}},get:function(){return this.ctx2d[n]}})});n.forEach(function(e){t[e]=function(){this.ctx2d[e].apply(this.ctx,arguments);return this}});r.forEach(function(e){t[e]=function(){return this.ctx2d[e].apply(this.ctx,arguments)}});e.declare("LibCanvas.Canvas2DContext",t)};new function(){var t=e.Transition,n=e.Color,r={};r.getColor=function(e){return new n(e||[0,0,0,1])};r.getPoints=function(t,n,r,i){var s=n.x-t.x,o=n.y-t.y,u=e.math.hypotenuse(s,o),a=o/u,f=s/u,l=a*r,c=f*r;return[new d(n.x+l,n.y+c*i),new d(n.x-l,n.y-c*i)]};r.getGradientFunction=function(n){switch(typeof n.gradient){case"undefined":return e.fn.lambda(r.getColor(n.color));case"function":return n.gradient;default:var i={fn:n.gradient.fn||"linear"};if(typeof i.fn!="string"){throw new Error("LibCanvas.Context2D.drawCurve -- unexpected type of gradient function")}i.from=r.getColor(n.gradient.from);i.to=r.getColor(n.gradient.to);var s=i.from.diff(i.to);return function(e){var n=t.get(i.fn)(e);return i.from.shift(s.clone().mul(n)).toString()}}};r.getWidthFunction=function(t){t.width=t.width||1;switch(typeof t.width){case"number":return e.fn.lambda(t.width);case"function":return t.width;case"object":return r.getWidthFunction.range(t.width);default:throw new TypeError("LibCanvas.Context2D.drawCurve -- unexpected type of width")}};r.getWidthFunction.range=function(e){if(!e.from||!e.to){throw new Error("LibCanvas.Context2D.drawCurve -- width.from or width.to undefined")}var n=e.to-e.from;return function(r){return e.from+n*t.get(e.fn||"linear")(r)}};r.curvesFunctions=[function(e,t){return{x:e[0].x+(e[1].x-e[0].x)*t,y:e[0].y+(e[1].y-e[0].y)*t}},function(e,t){var n=1-t;return{x:n*n*e[0].x+2*t*n*e[1].x+t*t*e[2].x,y:n*n*e[0].y+2*t*n*e[1].y+t*t*e[2].y}},function(e,t){var n=1-t;return{x:n*n*n*e[0].x+3*t*n*n*e[1].x+3*t*t*n*e[2].x+t*t*t*e[3].x,y:n*n*n*e[0].y+3*t*n*n*e[1].y+3*t*t*n*e[2].y+t*t*t*e[3].y}}];S.prototype.drawCurve=function(t){var n=e.array.append([d(t.from)],t.points.map(d),[d(t.to)]);var i=r.getGradientFunction(t),s=r.getWidthFunction(t),o=r.curvesFunctions[t.points.length];if(!o)throw new Error("LibCanvas.Context2D.drawCurve -- unexpected number of points");var u=t.step||.02;var a=t.inverted?1:-1;var f,l,c,h,p,v,m,g;l=o(n,-u);for(var y=-u;y<1.02;y+=u){f=o(n,y);v=i(y);p=s(y)/2;c=r.getPoints(l,f,p,a);if(y>=u){var b=r.getColor(m).diff(v);if(b.red+b.green+b.blue>150){g=this.createLinearGradient(l,f);g.addColorStop(0,m);g.addColorStop(1,v)}else{g=v}this.set("lineWidth",1).beginPath(h[0]).lineTo(h[1]).lineTo(c[1]).lineTo(c[0]).fill(g).stroke(g)}h=c;l=f;m=v}return this}};var T=e.declare("LibCanvas.Utils.Image",{canvasCache:null,initialize:function(e){this.image=e;this.cache={}},createSprite:function(e){var n,r,i,s,o,u,a,l,c,h,p,v,m;if(e.width<=0||e.height<=0){throw new TypeError("Wrong rectangle size")}n=this.image;r=f.buffer(e.width,e.height,true);if(e.from.x<0)i=t.ceil(t.abs(e.from.x)/e.width);if(e.from.y<0)s=t.ceil(t.abs(e.from.y)/e.height);if(i||s){e=e.clone().move(new d(i*n.width,s*n.height))}a=t.ceil(e.to.x/n.width);l=t.ceil(e.to.y/n.height);for(u=l;u-->0;)for(o=a;o-->0;){p=new d(o*n.width,u*n.height);v=p.clone();m=v.clone().move([n.width,n.height]);if(v.x<e.from.x)v.x=e.from.x;if(v.y<e.from.y)v.y=e.from.y;if(m.x>e.to.x)m.x=e.to.x;if(m.y>e.to.y)m.y=e.to.y;c=new w(v,m);h=c.size;c.from.x%=n.width;c.from.y%=n.height;c.size=h;if(o)p.x-=e.from.x;if(u)p.y-=e.from.y;if(h.width&&h.height)r.ctx.drawImage({image:n,crop:c,draw:new w(p,h)})}return r},toCanvas:function(){var e=this.canvasCache;if(!e){e=this.canvasCache=f.buffer(this,true);e.ctx.drawImage(this)}return e},isLoaded:function(){return this.constructor.isLoaded(this.image)},sprite:function(){if(!this.isLoaded())throw new Error("Not loaded in Image.sprite, logged");if(arguments.length){var e=w(arguments),t=e.dump(),n=this.cache[t];if(!n){n=this.cache[t]=this.createSprite(e)}return n}else{return this.toCanvas()}}});T.own({isLoaded:function(e){return e.complete&&(e.naturalWidth==null||!!e.naturalWidth)},sprite:function(e,t){return this.mix(e).sprite(t)},toCanvas:function(e){return this.mix(e).toCanvas()},mix:function(e){var t="libcanvas.image";if(!e[t]){e[t]=new this(e)}return e[t]}});var N=f.declare("LibCanvas.Plugins.ImageBuilder","ImageBuilder",{ctx:null,shape:null,images:[0,1,2,3,4,5,6,7,8],initialize:function(e){this.cropImage(e)},renderSingle:function(e,t,n){if(e!=null)this.ctx.drawImage({image:e,from:this.countShape(t,n).from});return this},renderRepeated:function(e,t,n){if(e!=null){var r=this.ctx.createPattern(e,"repeat");var i=this.countShape(t,n);this.ctx.translate(i.from).fill(new w(new d(0,0),i.size),r).translate(i.from,true)}return this},countShape:function(e,t){var n=this.shape.size,r=new d(0,0),i=new d(0,0);r.x=e=="left"?0:this.countBasis(e=="center"?"left":"right");r.y=t=="top"?0:this.countBasis(t=="middle"?"top":"bottom");i.x=e=="right"?n.width:this.countBasis(e=="center"?"right":"left");i.y=t=="bottom"?n.height:this.countBasis(t=="middle"?"bottom":"top");return(new w(r,i)).move(this.shape)},countBasis:function(e){var t=this.images,n=this.shape.size;switch(e){case"left":return t[0].width;case"right":return n.width-t[2].width;case"top":return t[0].height;case"bottom":return n.height-t[6].height;default:throw new TypeError("Wrong basis: "+e)}},renderParts:function(){var e=this.images;this.renderRepeated(e[1],"center","top").renderRepeated(e[3],"left","middle").renderRepeated(e[4],"center","middle").renderRepeated(e[5],"right","middle").renderRepeated(e[7],"center","bottom").renderSingle(e[0],"left","top").renderSingle(e[2],"right","top").renderSingle(e[6],"left","bottom").renderSingle(e[8],"right","bottom")},cropImage:function(e){var t,n,r,i,s,o,u=[],a=e.widths,f=e.heights;for(i=0,n=0;n<f.length;n++){o=f[n];for(r=0,t=0;t<a.length;t++){s=a[t];u.push(this.createCroppedImage(e.source,new w(r,i,s,o)));r+=s}i+=o}this.images=u},createCroppedImage:function(e,t){var n=f.buffer(t.size,true);n.ctx.drawImage({image:e,draw:n.ctx.rectangle,crop:t});return n},renderTo:function(e,t){this.ctx=e;this.shape=t;this.renderParts()}});e.declare("LibCanvas.Plugins.ImageBuilder.Horisontal",N,{images:[0,1,2],countBasis:function(e){var t=this.images,n=this.shape.size;switch(e){case"left":return t[0].width;case"right":return n.width-t[2].width;case"top":return 0;case"bottom":return n.height;default:throw new TypeError("Wrong basis: "+e)}},renderParts:function(){var e=this.images;this.renderRepeated(e[1],"center","middle").renderSingle(e[0],"left","middle").renderSingle(e[2],"right","middle")},cropImage:function(e){var t,n,r,i=[],s=e.widths;this.height=e.source.height;for(n=0,t=0;t<s.length;t++){r=s[t];i.push(this.createCroppedImage(e.source,new w(n,0,r,this.height)));n+=r}this.images=i}});e.declare("LibCanvas.Plugins.ImageBuilder.Vertical",N,{images:[0,1,2],countBasis:function(e){var t=this.images,n=this.shape.size;switch(e){case"left":return 0;case"right":return n.width;case"top":return t[0].height;case"bottom":return n.height-t[2].height;default:throw new TypeError("Wrong basis: "+e)}},renderParts:function(){var e=this.images;this.renderRepeated(e[1],"center","middle").renderSingle(e[0],"center","top").renderSingle(e[2],"center","bottom")},cropImage:function(e){var t,n,r,i=[],s=e.heights;this.width=e.source.width;for(n=0,t=0;t<s.length;t++){r=s[t];i.push(this.createCroppedImage(e.source,new w(0,n,this.width,r)));n+=r}this.images=i}});e.core.append(HTMLImageElement.prototype,{createSprite:function(e){return T.mix(this).createSprite(e)},toCanvas:function(){return T.mix(this).toCanvas()},sprite:function(){var e=T.mix(this);return e.sprite.apply(e,arguments)},isLoaded:function(){return T.isLoaded(this)}});e.core.append(HTMLCanvasElement.prototype,{createSprite:HTMLImageElement.prototype.createSprite,sprite:HTMLImageElement.prototype.sprite,isLoaded:e.fn.lambda(true),toCanvas:e.fn.lambda()});var C=function(){function u(e){var t=new r(9,8,[[1,1,1,0,0,0,-e[3][0],-e[3][0],-e[3][0]],[0,1,1,0,0,0,0,-e[2][0],-e[2][0]],[1,0,1,0,0,0,-e[1][0],0,-e[1][0]],[0,0,1,0,0,0,0,0,-e[0][0]],[0,0,0,-1,-1,-1,e[3][1],e[3][1],e[3][1]],[0,0,0,0,-1,-1,0,e[2][1],e[2][1]],[0,0,0,-1,0,-1,e[1][1],0,e[1][1]],[0,0,0,0,0,-1,0,0,e[0][1]]]);var n=t.rowEchelon().values;var i=new r(3,3,[[-n[0][8],-n[1][8],-n[2][8]],[-n[3][8],-n[4][8],-n[5][8]],[-n[6][8],-n[7][8],1]]);return i}S.prototype.projectiveImage=function(t){(new e(t.image)).setContext(this.ctx2d).setQuality(t.patchSize,t.limit).render(t.to);return this};var e=s("LibCanvas.Plugins.ProjectiveTexture",{initialize:function(e){if(typeof e=="string"){this.image=new Image;e.src=e}else{this.image=e}this.patchSize=64;this.limit=4},setQuality:function(e,t){this.patchSize=e==null?64:e;this.limit=t==null?4:t;return this},setContext:function(e){this.ctx=e;return this},render:function(e){var t=e.points;t=[[t[0].x,t[0].y],[t[1].x,t[1].y],[t[3].x,t[3].y],[t[2].x,t[2].y]];var r=u(t);var i=r.transformProjectiveVector([0,0,1]);var s=r.transformProjectiveVector([1,0,1]);var o=r.transformProjectiveVector([0,1,1]);var a=r.transformProjectiveVector([1,1,1]);this.transform=r;n.call(this,0,0,1,1,i,s,o,a,this.limit);return this}});var n=function(e,r,i,s,o,u,a,f,l){if(l){var c=[u[0]+a[0]-2*o[0],u[1]+a[1]-2*o[1]];var h=[u[0]+a[0]-2*f[0],u[1]+a[1]-2*f[1]];var p=[c[0]+h[0],c[1]+h[1]];var d=t.abs((p[0]*p[0]+p[1]*p[1])/(c[0]*h[0]+c[1]*h[1]));c=[u[0]-o[0]+f[0]-a[0],u[1]-o[1]+f[1]-a[1]];h=[a[0]-o[0]+f[0]-u[0],a[1]-o[1]+f[1]-u[1]];var v=t.abs(c[0]*h[1]-c[1]*h[0]);if(e==0&&i==1||(.25+d*5)*v>this.patchSize*this.patchSize){var m=(e+i)/2;var g=(r+s)/2;var y=this.transform;var b=y.transformProjectiveVector([m,g,1]);var w=y.transformProjectiveVector([m,r,1]);var E=y.transformProjectiveVector([m,s,1]);var S=y.transformProjectiveVector([e,g,1]);var x=y.transformProjectiveVector([i,g,1]);l--;n.call(this,e,r,m,g,o,w,S,b,l);n.call(this,m,r,i,g,w,u,b,x,l);n.call(this,e,g,m,s,S,b,a,E,l);n.call(this,m,g,i,s,b,x,E,f,l);return}}var T=this.ctx;T.save();T.beginPath();T.moveTo(o[0],o[1]);T.lineTo(u[0],u[1]);T.lineTo(f[0],f[1]);T.lineTo(a[0],a[1]);T.closePath();var N=[u[0]-o[0],u[1]-o[1]];var C=[f[0]-u[0],f[1]-u[1]];var k=[a[0]-f[0],a[1]-f[1]];var L=[o[0]-a[0],o[1]-a[1]];var A=t.abs(N[0]*L[1]-N[1]*L[0]);var O=t.abs(C[0]*N[1]-C[1]*N[0]);var M=t.abs(k[0]*C[1]-k[1]*C[0]);var _=t.abs(L[0]*k[1]-L[1]*k[0]);var D=t.max(t.max(A,O),t.max(_,M));var P=0,H=0,B=0,j=0;switch(D){case A:T.transform(N[0],N[1],-L[0],-L[1],o[0],o[1]);if(i!=1)B=1.05/t.sqrt(N[0]*N[0]+N[1]*N[1]);if(s!=1)j=1.05/t.sqrt(L[0]*L[0]+L[1]*L[1]);break;case O:T.transform(N[0],N[1],C[0],C[1],u[0],u[1]);if(i!=1)B=1.05/t.sqrt(N[0]*N[0]+N[1]*N[1]);if(s!=1)j=1.05/t.sqrt(C[0]*C[0]+C[1]*C[1]);P=-1;break;case M:T.transform(-k[0],-k[1],C[0],C[1],f[0],f[1]);if(i!=1)B=1.05/t.sqrt(k[0]*k[0]+k[1]*k[1]);if(s!=1)j=1.05/t.sqrt(C[0]*C[0]+C[1]*C[1]);P=-1;H=-1;break;case _:T.transform(-k[0],-k[1],-L[0],-L[1],a[0],a[1]);if(i!=1)B=1.05/t.sqrt(k[0]*k[0]+k[1]*k[1]);if(s!=1)j=1.05/t.sqrt(L[0]*L[0]+L[1]*L[1]);H=-1;break}var F=i-e;var I=s-r;var q=B*F;var R=j*I;var U=this.image.width;var z=this.image.height;T.drawImage(this.image,e*U,r*z,t.min(i-e+q,1)*U,t.min(s-r+R,1)*z,P,H,1+B,1+j);T.restore()};var r=function(e,t,n){this.w=e;this.h=t;this.values=n||i(t)};var i=function(e,t){var n=[];for(var r=0;r<t;++r){n[r]=[];for(var i=0;i<e;++i){n[r][i]=0}}return n};var o=function(e){var t=[];for(var n=0;n<e.length;++n){t[n]=[].concat(e[n])}return t};r.prototype={add:function(e){if(e.w!=this.w||e.h!=this.h){throw new Error("Matrix add size mismatch")}var t=i(this.w,this.h);for(var n=0;n<this.h;++n){for(var s=0;s<this.w;++s){t[n][s]=this.values[n][s]+e.values[n][s]}}return new r(this.w,this.h,t)},transformProjectiveVector:function(e){var t=[],n,r;for(r=0;r<this.h;++r){t[r]=0;for(n=0;n<this.w;++n){t[r]+=this.values[r][n]*e[n]}}var i=1/t[t.length-1];for(r=0;r<this.h;++r){t[r]*=i}return t},multiply:function(e){var t,n,s;if(+e!==e){if(e.h!=this.w){throw new Error("Matrix mult size mismatch")}t=i(this.w,this.h);for(s=0;s<this.h;++s){for(n=0;n<e.w;++n){var o=0;for(var u=0;u<this.w;u++){o+=this.values[s][u]*e.values[u][n]}t[s][n]=o}}return new r(e.w,this.h,t)}else{t=i(this.w,this.h);for(s=0;s<this.h;++s){for(n=0;n<this.w;++n){t[s][n]=this.values[s][n]*e}}return new r(this.w,this.h,t)}},rowEchelon:function(){if(this.w<=this.h){throw new Error("Matrix rowEchelon size mismatch")}var e=o(this.values);for(var t=0;t<this.h;++t){var n=e[t][t];while(n==0){for(var i=t+1;i<this.h;++i){if(e[i][t]!=0){var s=e[i];e[i]=e[t];e[t]=s;break}}if(i==this.h){return new r(this.w,this.h,e)}else{n=e[t][t]}}var u=1/n;for(var a=t;a<this.w;++a){e[t][a]*=u}for(var f=0;f<this.h;++f){if(f==t)continue;var l=e[f][t];e[f][t]=0;for(a=t+1;a<this.w;++a){e[f][a]-=l*e[t][a]}}}return new r(this.w,this.h,e)},invert:function(){var e,t;if(this.w!=this.h){throw new Error("Matrix invert size mismatch")}var n=i(this.w*2,this.h);for(t=0;t<this.h;++t){for(e=0;e<this.w;++e){n[t][e]=this.values[t][e];n[t][e+this.w]=e==t?1:0}}n=new r(this.w*2,this.h,n);n=n.rowEchelon();var s=i(this.w,this.h);for(t=0;t<this.w;++t){for(e=0;e<this.w;++e){s[t][e]=n.values[t][e+this.w]}}return new r(this.w,this.h,s)}};return e}();var k=f.declare("LibCanvas.Plugins.SpriteFont","SpriteFont",{initialize:function(e){if(typeof e=="string"){e=e.split("")}this.symbols=e;this.normal={};this.bold={}},make:function(e){e=new k.Sheet(this,e);var t=e.bold?this.bold:this.normal;if(t[e.size]){throw new TypeError("Size already exists")}t[e.size]=e;return e},get:function(e,t){var n=(t.bold?this.bold:this.normal)[t.size];if(n){return n.get(e,t.color)}else{throw new Error("No such sheet in font")}}});e.declare("LibCanvas.Plugins.SpriteFont.Sheet",{defaultColor:e.Color.colorNames.black,settings:{image:null,width:[],symbols:[],bold:false,size:false},initialize:function(t,n){this.settings=(new e.Settings(this.settings)).set(n);this.symbols=t.symbols;this.colors={};this.icons={}},get bold(){return this.settings.get("bold")},get size(){return this.settings.get("size")},get:function(t,n){if(t in this.icons){return this.icons[t]}if(!t in this.symbols){throw new TypeError("Unknown symbol: "+t)}if(n==null){n=this.defaultColor}n=e.Color(n).toString("hex");var r=this.colors;if(!r[n]){r[n]={}}if(!r[n][t]){r[n][t]=this.generateSymbol(t,n)}return r[n][t]},addIcon:e.core.overloadSetter(function(e,t){this.icons[e]=t}),generateSymbol:function(e,t){var n,r,i,s,o,u,a=this.settings.get("width"),l=false,c=this.symbols;for(n=0,s=0;n<c.length;n++){r=a[n];if(c[n]==e){l=true;break}s+=r}if(!l){throw new Error("No symbol in list: "+e)}o=this.settings.get("image");i=o.height;u=f.buffer(r,i,true);u.ctx.drawImage({image:o,crop:[s,0,r,i],draw:u.ctx.rectangle});if(t!=this.defaultColor){u.ctx.save().set({globalCompositeOperation:S.COMPOSITE.SOURCE_IN}).fillAll(t).restore()}return u}});e.declare("LibCanvas.Plugins.SpriteFont.Render",{initialize:function(t,n){this.ctx=t;this.options=e.core.append({size:16,bold:false,text:"",tags:"{*}",font:null,shape:null,color:"black",align:"left",lines:null,noWrap:false,letterSpacing:0,autoRender:true,forceSplit:false},n);this.options.text=String(this.options.text);if(this.options.autoRender){var r=this.parseAndGetLines();this.render(r)}},getLinesHeight:function(e){var t=0;for(var n=0;n<e.length;n++){t+=e[n].height}return t},parseAndGetLines:function(){var e=new k.Steps(this,new k.Lexer(this.options.text,this.options.tags));e.countSizes(this.options.font,this.options.letterSpacing);var t=this.options.lines;if(!t)t=new k.LinesEnRu;t.setConfig(this.options.font,this.options.noWrap,this.options.forceSplit);return t.run(e.steps,this.options.shape.width)},render:function(e){var n,r,i,s,o,u=this.options.shape.from;for(s=0,r=t.floor(u.y);s<e.length;s++){n=t.floor(u.x);if(this.options.align!="left"){i=e[s].reduce(function(e,t){return e+t.width},0);if(this.options.align=="center"){n+=parseInt((this.options.shape.width-i)/2)}if(this.options.align=="right"){n+=this.options.shape.width-i}}for(o=0;o<e[s].length;o++){this.ctx.drawImage(e[s][o].image,n,r);n+=e[s][o].width}r+=e[s].height}}});e.declare("LibCanvas.Plugins.SpriteFont.Steps",{tags:{bold:false,size:true,color:true},tagRegExp:/(\w+)(=.*)?/,initialize:function(t,n){this.steps=[];this.tokens=n.tokens;this.index=-1;this.split(e.object.collect(t.options,["color","size","bold"]))},split:function(e){var t,n=0,r=this.tokens.length,i=[e],s=function(){return i[i.length-1]};for(;n<r;n++){t=this.tokens[n];if(t.type=="string"){t.content.split("").forEach(function(e){this.steps.push({type:"symbol",content:e,mode:s()})}.bind(this))}else if(t.type=="nl"){this.steps.push(t)}else if(t.type=="tag"){if(this.isCloseModeTag(t)){i.pop()}else if(this.isChangeModeTag(t)){i.push(this.createMode(t,s()))}else{this.steps.push({type:"icon",content:t.content,mode:s()})}}else{throw new Error("Unknown type: "+t.type)}}},isChangeModeTag:function(e){return e.content.match(this.tagRegExp)[1]in this.tags},isCloseModeTag:function(e){return e.content=="/"},createMode:function(t,n){var r=t.content.match(this.tagRegExp),i=r[1],s=r[2],o=e.core.append({},n);if(this.tags[i]){if(s)s=s.substr(1);if(s=="")throw new Error("Value required in tag "+i)}else{s=true}o[i]=s;return o},countSizes:function(e,t){var n,r,i;for(n=0;n<this.steps.length;n++){r=this.steps[n];if(r.type=="symbol"||r.type=="icon"){i=e.get(r.content,r.mode);r.image=i;r.width=i.width+t;r.height=i.height}}}});e.declare("LibCanvas.Plugins.SpriteFont.Lexer",{initialize:function(e,t){this.string=e;this.tags=this.parseTags(t);this.tokens=this.tokenize()},tokenize:function(){var e=this.tags,t=this.string;return e?this.parseTaggedText(t,e):this.parsePlainText(t)},parseTaggedText:function(e,t){var n=0,r,i="",s=[],o=e.length;for(;n<o;n++){i=e[n];if(i=="\n"){if(r&&r.type=="tag"){throw new Error("Tag started, but not finished at symbol "+n)}s.push({type:"nl"});r=null}else if(i==t[0]){if(r&&r.type=="tag"){throw new Error("Wrong tag opening at symbol "+n)}s.push(r={type:"tag",content:""})}else if(!r){s.push(r={type:"string",content:e[n]})}else if(i==t[1]&&r.type=="tag"){r=null}else{r.content+=e[n]}}return s},parsePlainText:function(e){var t=0,n,r=[],i=e.length;for(;t<i;t++){if(e[t]=="\n"){n=null;r.push({type:"nl"})}else if(!n){n={type:"string",content:e[t]};r.push(n)}else{n.content+=e[t]}}return r},parseTags:function(e){function t(e){throw new TypeError('String like "[*]" required ('+e+")")}if(e==null)return null;if(typeof e!="string")t("typeof");e=e.split("*");if(e.length!=2)t("split");if(e[0].length!=1)t("left");if(e[1].length!=1)t("right");return e}});e.declare("LibCanvas.Plugins.SpriteFont.MorphemesFinder",{vowels:"AEIOUYaeiouyАОУЮИЫЕЭЯЁаоуюиыеэяёьЄІЇЎєіїў",initialize:function(){},isLetter:function(e){return e>="a"&&e<="z"||e>="A"&&e<="я"||e>="A"&&e<="Z"||e>="À"&&e<="ʨ"||e>="0"&&e<="9"||e>="Ά"&&e<="ӿ"},isVowel:function(e){return e&&e.length==1&&this.vowels.indexOf(e)>-1},isMorpheme:function(e){if(!e||e.length<=1)return false;for(var t=e.length;t--;)if(this.isVowel(e[t]))return true;return false},findMorphemes:function(t){var n=0,r,i=[],s="",o=[],u;var a=function(){u=i[i.length-1];if(Array.isArray(u)){e.array.append(u,o)}else{i.push(o)}o=[];s="";if(!this.isLetter(r)){i.push(t[n])}}.bind(this);for(;n<t.length;n++){r=t[n].content;if(t[n].type=="icon"){i.push(o);o=[];s="";i.push(t[n])}else if(t[n].type=="symbol"&&this.isLetter(r)){s+=r;o.push(t[n]);if(this.isMorpheme(s)){i.push(o);o=[];s=""}}else if(s){a()}else{i.push(t[n])}}if(s)a();return i}});e.declare("LibCanvas.Plugins.SpriteFont.LinesEnRu",{setConfig:function(e,t,n){this.font=e;this.noWrap=t;this.forceSplit=n;this.morphemesFinder=new k.MorphemesFinder},run:function(e,t){var n,r=[],i=[],s=false;for(n=0;n<e.length;n++){if(this.forceSplit){r.push(e[n])}else{if(e[n].type=="icon")s=true;if(e[n].type=="nl"||n==e.length-1){if(e[n].type!="nl"){r.push(e[n])}i.push(this.morphemesFinder.findMorphemes(r));r=[]}else{r.push(e[n])}}}if(this.forceSplit){i.push(r)}return this.countLines(i,t)},countLines:function(e,n){function f(e){if(!Array.isArray(e))e=[e];for(var t=0;t<e.length;t++){o.push(e[t]);u+=e[t].width}}var r=[],i,s,o=[],u=0,a;for(i=0;i<e.length;i++){for(s=0;s<e[i].length;s++){a=this.countLength(e[i][s]);if(a>n){throw new Error("Morpheme too long")}if(!this.noWrap&&(u+a>n||s==0&&i>0)){r.push(o);o=[];u=0}f(e[i][s])}}if(o.length>0)r.push(o);r.forEach(function(e){e.height=0;e.forEach(function(n){e.height=t.max(e.height,n.height)})});return r},countLength:function(t){if(Array.isArray(t)){return e.array.reduce(t,function(e,t){return e+t.width},0)}else{return t.width}}});var L=f.declare("LibCanvas.Shapes.Ellipse","Ellipse",w,{set:function(){this.bindMethods("update");w.prototype.set.apply(this,arguments)},_angle:0,get angle(){return this._angle},set angle(t){if(this._angle==t)return;this._angle=e.math.normalizeAngle(t);this.updateCache=true},update:function(){this.updateCache=true},rotate:function(e){this.angle+=e;return this},hasPoint:function(){var e=this.processPath(g().ctx);return e.isPointInPath(d(arguments))},cache:null,updateCache:true,countCache:function(){if(this.cache&&!this.updateCache){return this.cache}if(this.cache===null){this.cache=[];for(var e=12;e--;)this.cache.push(new d)}var t=this.cache,n=this._angle,r=.5522848,i=this.from.x,s=this.from.y,o=this.to.x,u=this.to.y,a=(o+i)/2,f=(u+s)/2,l=(o-i)/2*r,c=(u-s)/2*r;t[0].set(i,f-c);t[1].set(a-l,s);t[2].set(a,s);t[3].set(a+l,s);t[4].set(o,f-c);t[5].set(o,f);t[6].set(o,f+c);t[7].set(a+l,u);t[8].set(a,u);t[9].set(a-l,u);t[10].set(i,f+c);t[11].set(i,f);if(n){var h=new d(a,f);for(e=t.length;e--;)t[e].rotate(n,h)}return t},processPath:function(e,t){if(!t)e.beginPath();var n=this.countCache();e.beginPath(n[11]).bezierCurveTo(n[0],n[1],n[2]).bezierCurveTo(n[3],n[4],n[5]).bezierCurveTo(n[6],n[7],n[8]).bezierCurveTo(n[9],n[10],n[11]);if(!t)e.closePath();return e},equals:function(e,t){return w.prototype.equals.call(this,e,t)&&e.angle==this.angle},draw:function(e,t){this.processPath(e)[t]();return this},dump:function(e){return w.prototype.dump.call(this,e||"Ellipse")}});var A=function(){var n=function(t,n,r,i){return e.number.equals(t,n,i)||e.number.equals(t,r,i)||n<t&&t<r||r<t&&t<n};var r=t.PI/2;return f.declare("LibCanvas.Shapes.Line","Line",y,{set:function(t,n){var r=e.array.pickFrom(arguments);if(r.length===4){this.from=new d(r[0],r[1]);this.to=new d(r[2],r[3])}else{this.from=d.from(r[0]||r.from);this.to=d.from(r[1]||r.to)}return this},hasPoint:function(n){var r=this.from.x,i=this.from.y,s=this.to.x,o=this.to.y,u=n.x,a=n.y;if(!(e.number.between(n.x,t.min(r,s),t.max(r,s))&&e.number.between(n.y,t.min(i,o),t.max(i,o))))return false;return e.number.round((r-u)*(o-a)-(s-u)*(i-a),6)==0},getBoundingRectangle:function(){return(new w(this.from,this.to)).fillToPixel().grow(2)},intersect:function(t,r,i){if(t.constructor!=this.constructor){return this.getBoundingRectangle().intersect(t)}var s=this.from,o=this.to,u=t.from,a=t.to,f,l,c=r?null:false;if(e.number.equals(a.x,u.x,i)){if(e.number.equals(o.x,s.x,i)){if(e.number.equals(s.x,a.x,i)){if(e.number.between(s.y,u.y,a.y)){return s.clone()}else if(e.number.between(o.y,u.y,a.y)){return o.clone()}else{return c}}else{return c}}f=a.x;l=o.y+(f-o.x)*(s.y-o.y)/(s.x-o.x)}else{f=((s.x*o.y-o.x*s.y)*(a.x-u.x)-(u.x*a.y-a.x*u.y)*(o.x-s.x))/((s.y-o.y)*(a.x-u.x)-(u.y-a.y)*(o.x-s.x));l=((u.y-a.y)*f-(u.x*a.y-a.x*u.y))/(a.x-u.x);f*=-1}if(!n(f,s.x,o.x,i))return c;if(!n(l,s.y,o.y,i))return c;if(!n(f,u.x,a.x,i))return c;if(!n(l,u.y,a.y,i))return c;return r?new d(f,l):true},perpendicular:function(e){e=d(e);var t=this.from.x,n=this.from.y,r=this.to.x,i=this.to.y,s=e.x,o=e.y,u=(r-t)*(r-t),a=(i-n)*(i-n),f=((r-t)*(i-n)*(o-n)+t*a+s*u)/(u+a),l=(i-n)*(f-t)/(r-t)+n;return new d(f,l)},distanceTo:function(n,i){n=d(n);var s=this.from,o=this.to,u,a,f,l;if(!i){u=t.atan2(n.x-o.x,n.y-o.y);if(e.number.between(u,-r,r)){return o.distanceTo(n)}u=t.atan2(s.x-n.x,s.y-n.y);if(e.number.between(u,-r,r)){return s.distanceTo(n)}}a=t.abs(s.x*(o.y-n.y)+o.x*(n.y-s.y)+n.x*(s.y-o.y))/2;f=s.x-o.x;l=s.y-o.y;return 2*a/t.sqrt(f*f+l*l)},get length(){return this.to.distanceTo(this.from)},getLength:function(){return this.length},draw:function(e,t){e.beginPath();this.processPath(e,true)[t]();e.closePath();return this},processPath:function(e,t){if(!t)e.beginPath();e.moveTo(this.from).lineTo(this.to);if(!t)e.closePath();return e},dump:function(){return y.prototype.dump.call(this,"Line")}})}();var O=f.declare("LibCanvas.Shapes.Polygon","Polygon",y,{initialize:function I(){this.points=[];this._lines=[];I.previous.apply(this,arguments)},set:function(t){this.points.length=0;var n=Array.isArray(t)?t:e.core.toArray(arguments);e.array.append(this.points,n.filter(Boolean).map(d));this._lines.length=0;return this},get length(){return this.points.length},get lines(){var e=this._lines,t=this.points,n=t.length,r=0;if(e.length!=n)for(;r<n;r++){e.push(new A(t[r],r+1==n?t[0]:t[r+1]))}return this._lines},get center(){return(new d).mean(this.points)},get:function(e){return this.points[e]},getCoords:function(){return this.points[0]},processPath:function(e,t){var n=this.points,r=0,i=n.length;if(!t)e.beginPath();for(;r<=i;r++){if(r==0){e.moveTo(n[r])}else{e.lineTo(n[r==i?0:r])}}if(!t)e.closePath();return e},grow:function(){return this},getBoundingRectangle:function(){var e=this.points,n=e.length,r,i;if(n==0){throw new Error("Shape is empty")}while(n--){if(r){r.x=t.min(r.x,e[n].x);r.y=t.min(r.y,e[n].y);i.x=t.max(i.x,e[n].x);i.y=t.max(i.y,e[n].y)}else{r=e[n].clone();i=e[n].clone()}}return new w(r,i)},move:function(e,t){return this.invoke("move",e,t)},rotate:function(e,t){return this.invoke("rotate",e,t)},scale:function(e,t){return this.invoke("scale",e,t)},invoke:function(e,t){t=Array.prototype.slice.call(arguments,1);this.points.map(function(n){n[e].apply(n,t)});return this},forEach:function(e){this.points.forEach(e);return this},each:function(e,t){return this.forEach(t?e.bind(t):e)},hasPoint:function(t){t=d.from(t);var n=false,r=this.points;for(var i=0,s=this.length;i<s;i++){var o=(i||s)-1,u=r[i],a=r[o];if((e.number.between(t.y,u.y,a.y,"L")||e.number.between(t.y,a.y,u.y,"L"))&&t.x<(a.x-u.x)*(t.y-u.y)/(a.y-u.y)+u.x){n=!n}}return n},intersect:function(e){if(e.constructor!=this.constructor){return this.getBoundingRectangle().intersect(e)}var t=this.lines,n=e.lines,r=t.length,i=n.length;while(r-->0)for(i=n.length;i-->0;){if(t[r].intersect(n[i]))return true}return false},getPoints:function(){return e.array.toHash(this.points)},clone:function(){return new this.constructor(e.array.invoke(this.points,"clone"))}});var M=f.declare("LibCanvas.Shapes.Path","Path",O,{parts:[],initialize:function(e){this.parts=[];if(e)this.set(e)},set:function(e){this.parts.length=0;if(Array.isArray(e)){for(var t=0,n=e.length;t<n;t++){this.push(e[t])}}},get length(){return this.parts.length},moveTo:function(e){return this.push("moveTo",[d.from(e)])},lineTo:function(e){return this.push("lineTo",[d.from(e)])},curveTo:function(t,n,r){var i=e.array.pickFrom(arguments).map(d);return this.push("curveTo",i)},push:function(e,t){this.parts.push(M.Part.from(e,t));return this},unshift:function(e,t){this.parts.unshift(M.Part.from(e,t));return this},pop:function(){return this.parts.pop()},shift:function(){return this.parts.shift()},processPath:function(e,t){if(!t)e.beginPath();this.forEach(function(t){e[t.method].apply(e,t.points)});if(!t)e.closePath();return e},intersect:function(e){return this.getBoundingRectangle().intersect(e.getBoundingRectangle())},forEach:function(e){var t=this.parts,n=0,r=t.length;while(n<r){e.call(this,t[n++],n,this)}return this},get points(){var t=[];this.forEach(function(n){for(var r=0,i=n.points.length;r<i;r++){e.array.include(t,n.points[r])}});return t},hasPoint:function(e){var t=g().ctx;this.processPath(t);return t.isPointInPath(d.from(e))},clone:function(){return new this.constructor(this.parts.invoke("clone"))}});e.declare("LibCanvas.Shapes.Path.Part",{initialize:function(e,t){this.method=e;this.points=t.map(d)},clone:function(){return new this.constructor(this.method,this.points.invoke("clone"))}}).own({from:function(t,n){if(t==null){throw new Error("Empty path method")}if(typeof t=="string"){return new this(t,n)}else if(e.core.isArrayLike(t)){return new this(t[0],n[1])}else{return this}}});var _=f.declare("LibCanvas.Shapes.RoundedRectangle","RoundedRectangle",w,{radius:0,setRadius:function(e){this.radius=e;return this},draw:y.prototype.draw,processPath:function(e,t){var n=this.from,r=this.to,i=this.radius;if(!t)e.beginPath();e.moveTo(n.x,n.y+i).lineTo(n.x,r.y-i).curveTo(n.x,r.y,n.x+i,r.y).lineTo(r.x-i,r.y).curveTo(r.x,r.y,r.x,r.y-i).lineTo(r.x,n.y+i).curveTo(r.x,n.y,r.x-i,n.y).lineTo(n.x+i,n.y).curveTo(n.x,n.y,n.x,n.y+i);if(!t)e.closePath();return e},clone:function q(){return q.previous.apply(this,arguments).setRadius(this.radius)},equals:function(e,t){return w.prototype.equals.call(this,e,t)&&e.radius==this.radius},dump:function(){var e=function(e){return"["+e.x+", "+e.y+"]"};return"[shape RoundedRectangle(from"+e(this.from)+", to"+e(this.to)+", radius="+this.radius+")]"}});var D=s("LibCanvas.App.Behaviors",{behaviors:{},initialize:function(e){this.element=e;this.behaviors={}},getMouse:function(e){return this.element.layer.app.resources.get(e?"mouseHandler":"mouse")},add:function(e,t){if(typeof e=="string"){e=this.constructor[e]}return this.behaviors[e.index]=new e(this,i.call(arguments,1))},get:function(e){return this.behaviors[e]||null},startAll:function(e){this.invoke("start",arguments);return this},stopAll:function(){this.invoke("stop",arguments);return this},invoke:function(e,t){var n,r=this.behaviors;for(n in r)if(r.hasOwnProperty(n)){r[n][e].apply(r[n],t)}return this}}).own({attach:function(e,t,n){e.behaviors=new D(e);t.forEach(function(t){e.behaviors.add(t,n)});return e.behaviors}});s("LibCanvas.App.Behaviors.Behavior",{started:false,eventArgs:function(t,n){if(e.core.isFunction(t[0])){this.events.add(n,t[0])}},changeStatus:function(e){if(this.started==e){return false}else{this.started=e;return true}}});new function(){function e(e,t){var n=[e,t];return function(){if(this[e]!=t){this[e]=t;this.events.fire("statusChange",n)}}}return s("LibCanvas.App.Behaviors.Clickable",l.Behaviors.Behavior,{callbacks:{mouseover:e("hover",true),mouseout:function(){var t=e("hover",false),n=e("active",false);return function(e){t.call(this,e);n.call(this,e)}}(),mousedown:e("active",true),mouseup:e("active",false)},initialize:function(e,t){this.events=e.element.events;this.eventArgs(t,"statusChange")},start:function(){if(!this.changeStatus(true))return this;this.eventArgs(arguments,"statusChange");this.events.add(this.callbacks)},stop:function(){if(!this.changeStatus(false))return this;this.events.remove(this.callbacks)}}).own({index:"clickable"})};s("LibCanvas.App.Behaviors.Draggable",l.Behaviors.Behavior,{stopDrag:["up","out"],initialize:function(t,n){this.bindMethods(["onStop","onDrag","onStart"]);this.behaviors=t;this.element=t.element;if(!e.core.isFunction(this.element.move)){throw new TypeError("Element "+this.element+" must has «move» method")}this.events=t.element.events;this.eventArgs(n,"moveDrag")},bindMouse:function(e){var t=this.mouse,n=this.stopDrag;t.events[e]("move",this.onDrag)[e](n,this.onStop);return t},start:function(){if(!this.changeStatus(true))return this;this.mouse=this.behaviors.getMouse();if(!this.mouse)throw new Error("No mouse in element");this.eventArgs(arguments,"moveDrag");this.events.add("mousedown",this.onStart)},stop:function(){if(!this.changeStatus(false))return this;this.events.remove("mousedown",this.onStart)},onStart:function(e){if(e.button!==0)return;this.bindMouse("add");this.events.fire("startDrag",[e])},onDrag:function(e){if(!this.element.layer){return this.onStop(e,true)}var t=this.behaviors.getMouse().delta;this.element.move(t);this.events.fire("moveDrag",[t,e])},onStop:function(e,t){if(e.button===0||t===true){this.bindMouse("remove");this.events.fire("stopDrag",[e])}}}).own({index:"draggable"});s("LibCanvas.App.Light",{initialize:function(e,t){var n,r;this.settings=(new a({size:m.from(e),name:"main",mouse:true,invoke:false,simple:true,appendTo:"body",intersection:"auto"})).set(t||{});this.app=new l(this.settings.subset(["size","appendTo","simple"]));this.layer=this.app.createLayer(this.settings.subset(["name","invoke","intersection"]));if(this.settings.get("mouse")===true){n=new v(this.app.container.bounds);r=new l.MouseHandler({mouse:n,app:this.app});this.app.resources.set({mouse:n,mouseHandler:r})}},createVector:function(t,n){n=e.core.append({shape:t},n||{});return new l.Light.Vector(this.layer,n)},createText:function(t,n,r){r=e.core.append({shape:t,style:n},r);return new l.Light.Text(this.layer,r)},createImage:function(t,n,r){return new l.Light.Image(this.layer,e.core.append({shape:t,image:n},r))},get mouse(){return this.app.resources.get("mouse")},get mouseHandler(){return this.app.resources.get("mouseHandler")}});l.Light.Element=e.declare("LibCanvas.App.Light.Element",l.Element,{get behaviors(){throw new Error("Please, use `element.clickable` & `element.draggable` instead")},clickable:null,draggable:null,animatable:null,configure:function(){this.clickable=new l.Clickable(this,this.redraw);this.draggable=new l.Draggable(this,this.redraw);this.animatable=new e.Animatable(this);this.animate=this.animatable.animate;if(this.settings.get("mouse")!==false){this.listenMouse()}},animate:function(){},listenMouse:function(e){var t=e?"unsubscribe":"subscribe";return this.layer.app.resources.get("mouseHandler")[t](this)},destroy:function R(){this.listenMouse(true);return R.previous.call(this)}});l.Light.Image=e.declare("LibCanvas.App.Light.Image",l.Light.Element,{get currentBoundingShape(){return this.shape.clone().fillToPixel()},renderTo:function(e){e.drawImage({image:this.settings.get("image"),draw:this.shape})}});e.declare("LibCanvas.App.Light.Text",l.Element,{get style(){return this.settings.get("style")||{}},get content(){return this.style.text||""},set content(e){if(Array.isArray(e))e=e.join("\n");if(e!=this.content){this.redraw();this.style.text=String(e)||""}},renderTo:function(t){var n=this.settings.get("background");if(n)t.fill(this.shape,n);t.text(e.core.append({to:this.shape},this.style))}});l.Light.Vector=e.declare("LibCanvas.App.Light.Vector",l.Light.Element,{active:false,hover:false,configure:function U(){U.previous.call(this);this.style={};this.styleActive={};this.styleHover={}},setStyle:function(t,n){if(typeof t=="object"){n=t;t=""}t="style"+e.string.ucfirst(t);e.core.append(this[t],n);return this.redraw()},getStyle:function(e){if(!this.style)return null;var t=(this.active||null)&&this.styleActive[e],n=(this.hover||null)&&this.styleHover[e],r=this.style[e];return t!=null?t:n!=null?n:r!=null?r:null},get currentBoundingShape(){var e=this.shape.getBoundingRectangle(),n=this.getStyle("stroke")&&(this.getStyle("lineWidth")||1);return n?e.fillToPixel().grow(2*t.ceil(n)):e},renderTo:function(t){var n=this.getStyle("fill"),r=this.getStyle("stroke"),i=this.getStyle("lineWidth"),s=this.getStyle("opacity");if(s===0)return this;t.save();if(s)t.globalAlpha=e.number.round(s,3);if(n)t.fill(this.shape,n);if(r){t.lineWidth=i||1;t.stroke(this.shape,r)}t.restore();return this}});f.declare("LibCanvas.Engines.Hex","HexEngine",{});e.declare("LibCanvas.Engines.Hex.Projection",{multipliers:{height:t.cos(t.PI/6)*2,chord:1/2},initialize:function(e){e=this.settings=(new a({baseLength:0,chordLength:null,hexHeight:null,start:new d(0,0)})).set(e);if(e.get("chordLength")==null){e.set({chordLength:e.get("baseLength")*this.multipliers.chord,hexHeight:e.get("hexHeight")*this.multipliers.height})}},sizes:function(e){return new this.constructor.Sizes(this,e)},isZero:function(e){return e[0]===0&&e[1]===0&&e[2]===0},rgbToPoint:function(e){var t=e[0],n=e[1],r=e[2],i=this.settings,s=i.get("baseLength"),o=i.get("chordLength"),u=i.get("hexHeight"),a=i.get("start");if(t+n+r!==0){throw new Error("Wrong coordinates: "+t+" "+n+" "+r)}return new d(a.x+(s+o)*t,a.y+(r-n)*u/2)},pointToRgb:function(n){var r=this.settings,i=r.get("baseLength"),s=r.get("chordLength"),o=r.get("hexHeight"),u=r.get("start"),a=(n.x-u.x)/(i+s),f=(n.y-u.y-a*o/2)/o,l=0-a-f;var c=function(e){return t.abs(e[0]-a)+t.abs(e[1]-l)+t.abs(e[2]-f)};var h=t.floor(a),p=t.ceil(a),d=t.floor(l),v=t.ceil(l),m=t.floor(f),g=t.ceil(f);return[[h,d,m],[h,v,m],[h,d,g],[h,v,g],[p,d,m],[p,v,m],[p,d,g],[p,v,g]].filter(function(t){return e.array.sum(t)==0}).sort(function(e,t){return c(e)<c(t)?-1:1})[0]},createPolygon:function(e){var t=this.settings,n=t.get("baseLength")/2,r=t.get("hexHeight")/2,i=n+t.get("chordLength"),s=e.x+n,o=e.x-n,u=e.y-r,a=e.y+r;return new O([new d(o,u),new d(s,u),new d(e.x+i,e.y),new d(s,a),new d(o,a),new d(e.x-i,e.y)])}});s("LibCanvas.Engines.Hex.Projection.Sizes",{initialize:function(e,t){this.projection=e;this.padding=t||0;this.centers=[]},_limits:null,add:function(e){this._limits=null;this.centers.push(this.projection.rgbToPoint(e));return this},limits:function(){if(this._limits)return this._limits;var e,n,r=this.centers,i=r.length,s;while(i--){s=r[i];if(e==null){e=s.clone();n=s.clone()}else{e.x=t.min(e.x,s.x);e.y=t.min(e.y,s.y);n.x=t.max(n.x,s.x);n.y=t.max(n.y,s.y)}}return this._limits={min:e,max:n}},size:function(){var e=this.limits(),t=this.projection.settings,n=t.get("baseLength"),r=t.get("chordLength"),i=t.get("hexHeight"),s=this.padding;return new m(e.max.x-e.min.x+n+2*(s+r),e.max.y-e.min.y+i+2*s)},center:function(){var e=this.limits().min,t=this.projection.settings,n=t.get("baseLength"),r=t.get("chordLength"),i=t.get("hexHeight"),s=this.padding;return new d(s+n/2+r-e.x,s+i/2-e.y)}});f.declare("LibCanvas.Engines.Isometric","IsometricEngine",{});e.declare("LibCanvas.Engines.Isometric.Projection",{factor:[.866,.5,.866],size:1,start:[0,0],initialize:function(e){this.bindMethods(["toIsometric","to3D"]);this.settings=new a(e);this.factor=x(this.settings.get("factor")||this.factor);this.size=Number(this.settings.get("size")||this.size);this.start=d(this.settings.get("start")||this.start)},toIsometric:function(e){e=x(e);return(new d((e.y+e.x)*this.factor.x,(e.y-e.x)*this.factor.y-e.z*this.factor.z)).mul(this.size).move(this.start)},to3D:function(e,t){e=d(e);t=Number(t)||0;var n=this.size,r=this.start,i=((e.y-r.y)/n+t*this.factor.z)/this.factor.y,s=((e.x-r.x)/n/this.factor.x-i)/2;return new x(s,s+i,t)}});var P=f.declare("LibCanvas.Engines.Tile","TileEngine",{initialize:function(e){this.cells=[];this.methods={};this.cellsUpdate=[];this.events=new u(this);this.settings=(new a(e)).addEvents(this.events);this.createMatrix()},setMethod:e.core.overloadSetter(function(e,t){if(this.isValidMethod(t)){this.methods[e]=t}else{throw new TypeError("Unknown method: «"+e+"»")}}),countSize:function(){var e=this.settings,t=e.get("cellSize"),n=e.get("cellMargin");return new m((t.x+n.x)*this.width-n.x,(t.y+n.y)*this.height-n.y)},getCellByIndex:function(e){e=d.from(e);return this.isIndexOutOfBounds(e)?null:this.cells[this.width*e.y+e.x]},getCellByPoint:function(e){var t=this.settings,n=t.get("cellSize"),r=t.get("cellMargin");e=d.from(e);return this.getCellByIndex(new d(parseInt(e.x/(n.width+r.x)),parseInt(e.y/(n.height+r.y))))},refresh:function(t,n){if(this.requireUpdate){t.save();if(n)t.translate(n);e.array.invoke(this.cellsUpdate,"renderTo",t);t.restore();this.cellsUpdate.length=0}return this},get width(){return this.settings.get("size").width},get height(){return this.settings.get("size").height},get requireUpdate(){return!!this.cellsUpdate.length},isValidMethod:function(t){var n=typeof t;return n=="function"||n=="string"||e.dom.isElement(t)},createMatrix:function(){var e,t,n=this.settings,r=n.get("size"),i=n.get("defaultValue"),s=n.get("cellSize"),o=n.get("cellMargin");for(t=0;t<r.height;t++)for(e=0;e<r.width;e++){this.createMatrixCell(new d(e,t),s,o,i)}return this},createMatrixCell:function(e,t,n,r){var i=this.createCellRectangle(e,t,n);this.cells.push(this.createCell(e,i,r))},createCell:function(e,t,n){return new P.Cell(this,e,t,n)},createCellRectangle:function(e,t,n){return new w({from:new d((t.x+n.x)*e.x,(t.y+n.y)*e.y),size:t})},isIndexOutOfBounds:function(e){return e.x<0||e.y<0||e.x>=this.width||e.y>=this.height},updateCell:function(t){if(!this.requireUpdate){this.events.fire("update",[this])}e.array.include(this.cellsUpdate,t);return this}});s("LibCanvas.Engines.Tile.Cell",{initialize:function(e,t,n,r){this.engine=e;this.point=t;this.value=r;this.rectangle=n},_value:null,get value(){return this._value},set value(e){this._value=e;this.engine.updateCell(this)},renderTo:function(t){var n,r=this.value,i=this.rectangle;t.clear(i);if(r==null)return this;n=this.engine.methods[r];if(n==null){throw new Error("No method in tile engine: «"+this.value+"»")}if(e.dom.isElement(n)){t.drawImage(n,i)}else if(typeof n=="function"){n.call(this,t,this)}else{t.fill(i,n)}return this}});s("LibCanvas.Engines.Tile.Element",l.Element,{configure:function(){this.shape=new w(this.settings.get("from")||new d(0,0),this.engine.countSize());this.engine.events.add("update",this.redraw)},get engine(){return this.settings.get("engine")},clearPrevious:function(){},renderTo:function(e){this.engine.refresh(e,this.shape.from)}}).own({app:function(e,t,n){return new this(e.createLayer({name:"tile-engine",intersection:"manual",invoke:false}),{engine:t,from:n})}});s("LibCanvas.Engines.Tile.Mouse",{eventsList:"mousemove mouseout mousedown mouseup contextmenu".split(" "),initialize:function(e,t){this.bindMethods(this.eventsList);this.events=new u(this);this.mouse=t;this.element=e;this.previous=null;this.lastDown=null;this.subscribe(false)},subscribe:function(t){var n=e.object.collect(this,this.eventsList,null);this.element.events[t?"remove":"add"](n)},mousemove:function(e){var t=this.get();if(this.previous!=t){this.outCell(e);this.fire("over",t,e);this.previous=t}},mouseout:function(e){this.outCell(e)},mousedown:function(e){var t=this.get();this.fire("down",t,e);this.lastDown=t},mouseup:function(e){var t=this.get();this.fire("up",t,e);if(t!=null&&t==this.lastDown){this.fire("click",t,e)}this.lastDown=null},contextmenu:function(e){var t=this.get();if(t!=null){this.fire("contextmenu",t,e)}},get:function(){return this.element.engine.getCellByPoint(this.mouse.point.clone().move(this.element.shape.from,true))},fire:function(e,t,n){return this.events.fire(e,[t,n])},outCell:function(e){if(this.previous){this.fire("out",this.previous,e);this.previous=null}}});var H=f.declare("LibCanvas.Plugins.Animation","Animation",{ownStartTime:null,timeoutId:0,synchronizedWith:null,initialize:function(t){this.bindMethods("update");this.events=new e.Events(this);this.settings=(new e.Settings(t)).addEvents(this.events);this.run()},stop:function(){this.startTime=null;return this.update()},run:function(){this.startTime=Date.now();return this.update()},synchronize:function(e){this.synchronizedWith=e;return this},get:function(){return this.sheet.get(this.startTime)},get sheet(){return this.settings.get("sheet")},set sheet(e){return this.settings.set("sheet",e)},set startTime(e){this.ownStartTime=e},get startTime(){if(this.synchronizedWith){return this.synchronizedWith.startTime}else{return this.ownStartTime}},update:function(){var e=this.getDelay();clearTimeout(this.timeoutId);if(e==null||this.startTime==null){this.events.fire("stop")}else{this.timeoutId=setTimeout(this.update,e);this.events.fire("update",[this.get()])}return this},getDelay:function(){return this.startTime==null?null:this.sheet.getCurrentDelay(this.startTime)}});e.declare("LibCanvas.Plugins.Animation.Frames",{sprites:[],initialize:function(e,n,r){if(e==null)throw new TypeError("`image` cant be null");this.sprites=[];this.image=e;this.size=new m(t.round(n==null?e.width:n),t.round(r==null?e.height:r));this.prepare()},get:function(e){var t=this.sprites[e];if(!t){throw new Error("No sprite with such id: "+e)}return t},get length(){return this.sprites.length},prepare:function(){var e,t,n=this.image,r=this.size.width,i=this.size.height;for(t=0;t<=n.height-i;t+=i){for(e=0;e<=n.width-r;e+=r){this.sprites.push(this.makeSprite(new d(e,t)))}}if(!this.length){throw new TypeError("Animation is empty")}},makeSprite:function(e){var t=this.size,n=f.buffer(t,true);n.ctx.drawImage({image:this.image,draw:n.ctx.rectangle,crop:new w(e,t)});return n}});e.declare("LibCanvas.Plugins.Animation.Image",{initialize:function(t){this.bindMethods("update");if(t instanceof H.Sheet){t={sheet:t}}if(!(t instanceof H)){t=new H(t)}this.buffer=f.buffer(t.sheet.size,true);this.element=e.dom(this.buffer);this.animation=t;this.element.controller=this;t.events.add("update",this.update)},update:function(e){var t=this.buffer.ctx;t.clearAll();if(e)t.drawImage(e)}}).own({element:function(e){return(new this(e)).element}});e.declare("LibCanvas.Plugins.Animation.Sheet",{initialize:function(t){this.frames=t.frames;this.delay=t.delay;this.looped=t.looped;if(t.sequence==null){this.sequence=e.array.range(0,this.frames.length-1)}else{this.sequence=t.sequence}},get size(){return this.frames.size},get:function(e){if(e==null)return null;var t=this.getFrameId(this.countFrames(e));return t==null?t:this.frames.get(t)},getCurrentDelay:function(e){var t,n;t=this.countFrames(e);if(this.getFrameId(t)==null){return null}n=t*this.delay+e;return this.delay-(Date.now()-n)},getFrameId:function(e){if(this.looped){return this.sequence[e%this.sequence.length]}else if(e>=this.sequence.length){return null}else{return this.sequence[e]}},countFrames:function(e){return t.floor((Date.now()-e)/this.delay)}});e.declare("LibCanvas.Plugins.Curve",{step:1e-4,initialize:function(e){var t=this.constructor.classes[e.points.length];if(t)return new t(e);this.setData(e)},setData:function(e){this.from=e.from;this.to=e.to;this.cp=e.points},getAngle:function(e){var t;if(e<this.step){t=e-this.step}else{t=e;e+=this.step}return this.getPoint(e).angleTo(this.getPoint(t))}}).own({classes:{},addClass:function(e,t){this.classes[e]=t}});e.declare("LibCanvas.Plugins.Curve.Quadratic",f.Plugins.Curve,{initialize:function(e){this.setData(e)},getPoint:function(e){var t=this.from,n=this.to,r=this.cp[0],i=1-e;return new d(i*i*t.x+2*e*i*r.x+e*e*n.x,i*i*t.y+2*e*i*r.y+e*e*n.y)}});f.Plugins.Curve.addClass(1,f.Plugins.Curve.Quadratic);e.declare("LibCanvas.Plugins.Curve.Qubic",f.Plugins.Curve,{initialize:function(e){this.setData(e)},getPoint:function(e){var t=this.from,n=this.to,r=this.cp,i=1-e;return new d(i*i*i*t.x+3*e*i*i*r[0].x+3*e*e*i*r[1].x+e*e*e*n.x,i*i*i*t.y+3*e*i*i*r[0].y+3*e*e*i*r[1].y+e*e*e*n.y)}});f.Plugins.Curve.addClass(2,f.Plugins.Curve.Qubic)}).call(typeof window=="undefined"?exports:window,atom,Math)